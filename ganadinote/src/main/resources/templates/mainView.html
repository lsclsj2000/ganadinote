<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainLayoutView}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>강아지 날씨 예보</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/ljs.css">
    <style>
        /* 반려동물 프로필 스타일 */
        #pet-cards-container { display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start; margin-bottom: 20px; }
        .pet-avatar-item { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .pet-avatar-img-wrapper { width: 70px; height: 70px; border-radius: 50%; overflow: hidden; border: 2px solid #eee; }
        .pet-avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .pet-avatar-name { font-size: 0.9rem; font-weight: 500; text-align: center; margin: 0; }

        /* 날씨 대시보드 스타일 */
        .weather-dashboard { font-family: 'Noto Sans KR', sans-serif; }
        .current-weather-summary { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: space-around;}
        .current-weather-summary .icon { width: 10rem; height: 10rem; }
        .current-weather-summary .temp-main { font-size: 3rem; font-weight: 700; letter-spacing: -2px; }
        .current-weather-summary .temp-main sup { font-size: 1.5rem; top: -1rem; }
        .current-weather-summary .temp-details p { margin: 0; color: #555; font-size: 1.5rem; }
        .current-weather-summary .weather-desc { font-size: 1.1rem; font-weight: 500; margin-bottom: 5px; }

        /* ▼▼▼ [수정] 미세먼지 카드 그리드: 모바일에서 2열, 특정 너비 이상에서 4열로 변경 ▼▼▼ */
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); /* 모바일 기본 2열 */ gap: 10px; margin-bottom: 20px; }
        
        .info-box { background-color: #f8f9fa; border-radius: 12px; padding: 15px; text-align: center; }
        .info-box .title { font-size: 1.1rem; color: #6c757d; margin-bottom: 5px; }
        .info-box .value { font-size: 1.2rem; font-weight: 700; }
        .info-box .value.good { color: #0d6efd; }
        .info-box .value.normal { color: #198754; }
        .info-box .value.bad { color: #ffc107; }
        .info-box .value.very-bad { color: #dc3545; }

        /* ▼▼▼ [수정] 시간별 예보 컨테이너: 컨테이너 자체를 스크롤하도록 변경 ▼▼▼ */
        .hourly-forecast-container { 
            position: relative; 
            overflow-x: auto; /* 컨테이너가 스크롤을 담당 */
            padding-bottom: 15px;
        }
        .hourly-forecast { display: flex; min-width: 1200px; }
        .hour-item { display: flex; flex-direction: column; align-items: center; text-align: center; width: 50px; flex-shrink: 0; }
        .hour-item .time { font-size: 0.8rem; color: #6c757d; }
        .hour-item .icon { width: 40px; height: 40px; }
        .hour-item .temp { font-size: 0.9rem; font-weight: 500; margin-top: 20px; }
        .temp-graph { position: absolute; top: 70px; left: 0; width: 1200px; height: 30px; pointer-events: none; } /* 너비를 리스트와 동일하게 */
        .temp-graph svg { width: 100%; height: 100%; overflow: visible; }
        .temp-graph .line { fill: none; stroke: #ffc107; stroke-width: 2; }
        .temp-graph .dot { fill: #ffc107; stroke: white; stroke-width: 2; }
        
        /* 주간 예보 */
        #daily-forecast-list { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .daily-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: 12px; border: 1px solid #eee; }
        .daily-item .day-info { display: flex; flex-direction: column; align-items: flex-start; flex-basis: 60px; }
        .daily-item .day-info strong { font-size: 1.1em; }
        .daily-item .day-info span { font-size: 0.8em; color: #6c757d; }
        .daily-item .forecast-group { display: flex; gap: 10px; flex-grow: 1; justify-content: center; }
        .daily-item .sub-forecast { display: flex; flex-direction: column; align-items: center; font-size: 0.8em; width: 50px; }
        .daily-item .sub-forecast .pop { color: #0d6efd; margin-bottom: 2px; }
        .daily-item .sub-forecast img { width: 35px; height: 35px; }
        .daily-item .temp-info { display: flex; gap: 8px; font-weight: 700; flex-basis: 70px; justify-content: flex-end; }
        .daily-item .temp-info .min-temp { color: #0d6efd; }
        .daily-item .temp-info .max-temp { color: #dc3545; }

        /* 반응형 미디어 쿼리 */
        @media (min-width: 576px) {
            .info-grid {
                grid-template-columns: repeat(4, 1fr); /* 작은 화면 이상: 4열 */
            }
        }
        @media (min-width: 768px) {
            #daily-forecast-list {
                grid-template-columns: 1fr 1fr; /* 태블릿 이상: 2열 */
                gap: 15px;
            }
            .current-weather-summary .icon { width: 10rem; height: 10rem; }
            .current-weather-summary .temp-main { font-size: 3.5rem; }
        }
    </style>
</head>

<div layout:fragment="contents">
    <div class="page-heading mt-3">
        <h3>내 강아지</h3>
    </div>
    <div class="page-content">
        <section class="row">
            <div class="col-12 col-lg-9">
                <!-- 반려동물 정보 -->
                <div id="pet-cards-container">
                    <p id="loading-message">반려동물 정보를 불러오는 중...</p>
                </div>
                <!-- 날씨 정보 카드 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header"><h4 id="dong-name">위치 정보를 불러오는 중...</h4></div>
                            <div class="card-body weather-dashboard">
                                <p id="status-message"></p>
                                <div id="weather-cards-container" style="display:none;">
                                    <div id="current-weather-summary" class="current-weather-summary">
                                        <img id="current-weather-icon" src="" alt="weather icon" class="icon">
                                        <div class="temp-details">
                                            <p id="current-weather-desc" class="weather-desc">---</p>
                                            <div id="current-temp-main" class="temp-main">--.-<sup>&deg;</sup></div>
                                            <p id="current-temp-details">체감 --.-&deg; &bull; 습도 --% &bull; 바람 ---m/s</p>
                                        </div>
                                    </div>
                                    <div class="info-grid">
                                        <div class="info-box"><div class="title">미세먼지(PM10)</div><div id="info-pm10" class="value">---</div></div>
                                        <div class="info-box"><div class="title">초미세먼지(PM2.5)</div><div id="info-pm25" class="value">---</div></div>
                                        <div class="info-box"><div class="title">자외선</div><div id="info-uvi" class="value">---</div></div>
                                        <div class="info-box"><div class="title">일출</div><div id="info-sunrise" class="value">--:--</div></div>
                                    </div>
                                    <hr>
                                    <h5 class="mt-4 mb-3">시간별 예보</h5>
                                    <!-- ▼▼▼ [수정] HTML 구조 단순화: wrapper 제거 ▼▼▼ -->
                                    <div class="hourly-forecast-container">
                                        <div class="temp-graph"><svg id="temp-graph-svg"></svg></div>
                                        <div id="hourly-forecast-list" class="hourly-forecast"></div>
                                    </div>
                                    <hr>
                                    <h5 class="mt-4 mb-3">주간 예보</h5>
                                    <div id="daily-forecast-list"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 오른쪽 사이드바 -->
            <div class="col-12 col-lg-3">
                 <!-- ... 오른쪽 사이드바 내용 ... -->
            </div>
        </section>
    </div>
</div>

<th:block layout:fragment="jsScripts">
    <script th:inline="javascript">
        // --- 1. 유틸리티 함수 ---
        const formatTime = (unixTimestamp) => { const date = new Date(unixTimestamp * 1000); return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; };
        const getAqiText = (value, type) => { const thresholds = { pm10: [30, 80, 150], pm25: [15, 35, 75] }; let level = 1; if (value > thresholds[type][2]) level = 4; else if (value > thresholds[type][1]) level = 3; else if (value > thresholds[type][0]) level = 2; const levels = [{text: '좋음', className: 'good'}, {text: '보통', className: 'normal'}, {text: '나쁨', className: 'bad'}, {text: '매우 나쁨', className: 'very-bad'}]; return `<span class="${levels[level-1].className}">${levels[level-1].text}</span>`; };
        const getUviText = (uvi) => { let level = '낮음'; if (uvi >= 11) level = '위험'; else if (uvi >= 8) level = '매우 높음'; else if (uvi >= 6) level = '높음'; else if (uvi >= 3) level = '보통'; return level; };

        // --- 2. 반려동물 정보 로드 기능 (원형 프로필로 생성) ---
        const mbrCd = '1';
        async function fetchAndRenderPets(memberCode) {
            const container = document.getElementById('pet-cards-container');
            const loadingMessage = document.getElementById('loading-message');
            if (!container || !loadingMessage) return;
            loadingMessage.style.display = 'block';
            container.innerHTML = '';
            try {
                const response = await fetch(`/mainapi/pets/${memberCode}`);
                if (!response.ok) throw new Error('서버 응답 오류');
                const pets = await response.json();
                loadingMessage.style.display = 'none';
                if (pets.length === 0) {
                    container.innerHTML = `<p class="text-muted text-center col-12">등록된 반려동물이 없습니다.</p>`;
                } else {
                    pets.forEach(pet => container.insertAdjacentHTML('beforeend', createPetCard(pet.petName, pet.petProfileImgUrl)));
                }
            } catch (error) {
                loadingMessage.style.display = 'none';
                container.innerHTML = `<p class="text-danger text-center col-12">반려동물 정보를 불러오는 데 실패했습니다.</p>`;
            }
        }
        function createPetCard(petName, profileImgUrl) {
            const imageUrl = profileImgUrl || '/assets/images/logo/favicon.svg';
            return `
                <div class="pet-avatar-item">
                    <div class="pet-avatar-img-wrapper">
                        <img src="${imageUrl}" class="pet-avatar-img" alt="${petName} 프로필" onerror="this.onerror=null; this.src='/assets/images/logo/favicon.svg';">
                    </div>
                    <p class="pet-avatar-name">${petName}</p>
                </div>
            `;
        }

        // --- 3. 위치 및 데이터 로드 기능 ---
        async function getLocationName() {
            const statusMessage = document.getElementById('status-message');
            const locationNameElement = document.getElementById('dong-name');
            const processCoordinates = async (lat, lon) => {
                try {
                    const locResponse = await fetch(`/locationapi/location`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ latitude: lat, longitude: lon }) });
                    const locData = await locResponse.json();
                    if (locData.locationName) locationNameElement.textContent = `현재 위치: '${locData.locationName}'`;
                    await Promise.all([ fetchWeatherData(lat, lon), fetchAirPollution(lat, lon) ]);
                } catch (error) { statusMessage.textContent = "위치/날씨 처리 중 오류 발생"; }
            };
            const fetchIpLocation = async () => {
                try {
                    statusMessage.textContent = 'GPS 사용 불가. IP 기반 위치 추정 중...';
                    const response = await fetch('/locationapi/ipLocation');
                    const data = await response.json();
                    if (data.locationName) locationNameElement.textContent = `현재 위치(대략): '${data.locationName}'`;
                    if (data.lat && data.lon) await processCoordinates(data.lat, data.lon);
                } catch (error) { statusMessage.textContent = `오류: ${error.message}`; }
            };
            try {
                if (!navigator.geolocation) { await fetchIpLocation(); return; }
                statusMessage.textContent = '위치 정보 가져오는 중...';
                locationNameElement.textContent = '위치 정보를 분석 중입니다...';
                const position = await new Promise((resolve, reject) => { navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 }); });
                await processCoordinates(position.coords.latitude, position.coords.longitude);
            } catch (error) { await fetchIpLocation(); }
        }
        async function fetchWeatherData(lat, lon) {
            try {
                const response = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
                if (!response.ok) throw new Error('날씨 서버 통신 오류');
                const data = await response.json();
                if (!data.current || !data.hourly || !data.daily) throw new Error('수신된 날씨 데이터 형식이 올바르지 않습니다.');
                displayWeatherData(data);
                document.getElementById('weather-cards-container').style.display = 'block';
                document.getElementById('status-message').textContent = '';
            } catch (error) { document.getElementById('status-message').textContent = `오류: ${error.message}`; }
        }
        async function fetchAirPollution(lat, lon) {
            try {
                const response = await fetch(`/api/weather/air-pollution?lat=${lat}&lon=${lon}`);
                if (!response.ok) throw new Error('대기질 서버 통신 오류');
                const data = await response.json();
                displayAirPollution(data);
            } catch (error) { 
                document.getElementById('info-pm10').innerHTML = `<span class="bad">오류</span>`;
                document.getElementById('info-pm25').innerHTML = `<span class="bad">오류</span>`;
            }
        }

        // --- 4. 데이터 표시 기능 ---
        function displayWeatherData(data) {
            const current = data.current;
            document.getElementById('current-weather-icon').src = `https://openweathermap.org/img/wn/${current.weather[0].icon}@4x.png`;
            document.getElementById('current-weather-desc').textContent = current.weather[0].description;
            document.getElementById('current-temp-main').innerHTML = `${current.temp.toFixed(1)}<sup>&deg;</sup>`;
            document.getElementById('current-temp-details').textContent = `체감 ${current.feels_like.toFixed(1)}° • 습도 ${current.humidity}% • 바람 ${current.wind_speed}m/s`;
            document.getElementById('info-uvi').innerHTML = getUviText(current.uvi);
            document.getElementById('info-sunrise').textContent = formatTime(current.sunrise);
            const hourly = data.hourly.slice(0, 24);
            const hourlyList = document.getElementById('hourly-forecast-list');
            hourlyList.innerHTML = '';
            hourly.forEach((hour, index) => {
                let timeLabel = `${new Date(hour.dt * 1000).getHours()}시`;
                if(index === 0) timeLabel = '지금';
                hourlyList.innerHTML += `<div class="hour-item"><div class="time">${timeLabel}</div><img src="https://openweathermap.org/img/wn/${hour.weather[0].icon}.png" class="icon" alt=""><div class="temp">${Math.round(hour.temp)}°</div></div>`;
            });
            drawTempGraph(hourly);
            const dailyList = document.getElementById('daily-forecast-list');
            dailyList.innerHTML = '';
            data.daily.slice(0, 8).forEach((day, index) => {
                const dateObj = new Date(day.dt * 1000);
                const dayOfWeek = ['일', '월', '화', '수', '목', '금', '토'][dateObj.getDay()];
                const dateString = `${dateObj.getMonth() + 1}.${dateObj.getDate()}`;
                let dayLabel = dayOfWeek;
                if (index === 0) dayLabel = '오늘';
                if (index === 1) dayLabel = '내일';
                const hourlyForThisDay = data.hourly.filter(h => new Date(h.dt * 1000).getDate() === dateObj.getDate());
                const am = hourlyForThisDay.find(h => new Date(h.dt * 1000).getHours() === 9) || hourlyForThisDay.find(h => new Date(h.dt * 1000).getHours() < 12) || day;
                const pm = hourlyForThisDay.find(h => new Date(h.dt * 1000).getHours() === 15) || hourlyForThisDay.find(h => new Date(h.dt * 1000).getHours() > 12) || day;
                const amPop = Math.round((am.pop || 0) * 100);
                const pmPop = Math.round((pm.pop || 0) * 100);
                const amIconUrl = `https://openweathermap.org/img/wn/${am.weather[0].icon}.png`;
                const pmIconUrl = `https://openweathermap.org/img/wn/${pm.weather[0].icon}.png`;
                dailyList.innerHTML += `<div class="daily-item"><div class="day-info"><strong>${dayLabel}</strong><span>${dateString}</span></div><div class="forecast-group"><div class="sub-forecast"><span class="pop">${amPop}%</span><img src="${amIconUrl}"></div><div class="sub-forecast"><span class="pop">${pmPop}%</span><img src="${pmIconUrl}"></div></div><div class="temp-info"><span class="min-temp">${Math.round(day.temp.min)}°</span><span class="max-temp">${Math.round(day.temp.max)}°</span></div></div>`;
            });
        }
        function displayAirPollution(data) {
            const components = data.list[0].components;
            document.getElementById('info-pm10').innerHTML = getAqiText(components.pm10, 'pm10');
            document.getElementById('info-pm25').innerHTML = getAqiText(components.pm2_5, 'pm25');
        }
        function drawTempGraph(hourlyData) {
            const svg = document.getElementById('temp-graph-svg');
            if (!svg) return;
            const temps = hourlyData.map(h => h.temp);
            const minTemp = Math.min(...temps);
            const maxTemp = Math.max(...temps);
            const tempRange = maxTemp - minTemp || 1;
            const points = hourlyData.map((hour, index) => ({ x: 25 + index * 50, y: 28 - ((hour.temp - minTemp) / tempRange) * 25 }));
            const pathData = points.map((p, i) => i === 0 ? `M ${p.x} ${p.y}` : `L ${p.x} ${p.y}`).join(' ');
            const dotsHtml = points.map(p => `<circle cx="${p.x}" cy="${p.y}" r="3" class="dot" />`).join('');
            svg.innerHTML = `<path d="${pathData}" class="line" />${dotsHtml}`;
        }
        
        // --- 5. 페이지가 로드되면 모든 기능을 실행 ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderPets(mbrCd);
            getLocationName(); 
        });
    </script>
</th:block>

</html>