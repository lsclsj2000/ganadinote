<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainLayoutView}">
<head>
    <meta charset="UTF-8">
    <title>알림 설정</title>
    <style>
        .day-label {
            width: 80px; /* 요일 라벨 너비 증가 */
            min-width: 80px;
        }
        .current-time-display {
            width: 100px; /* 현재 시간 표시 너비 증가 */
            min-width: 100px;
        }
    </style>
</head>
<body>
    <th:block layout:fragment="contents">
        <div class="container my-5">
            <h1 class="text-center mb-4">알림 설정</h1>
            <div class="card p-4">
                <p id="subscription-status">알림 상태를 확인 중입니다...</p>
                <button id="toggle-subscribe-button" class="btn btn-primary mt-3" disabled>로딩 중...</button>
                
                <hr class="my-4">
                
                <h4>강아지별 산책 정보</h4>
                <div th:each="pet : ${pets}" th:if="${pet}" class="border p-3 mb-3">
                    <h5 th:text="${pet.petName}">강아지 이름</h5>
                    <p>
                        <span th:text="${pet.petBreed}">품종</span>, 
                        <span th:text="${pet.petWeight}">체중</span>kg
                    </p>
                    <p>
                        적정 온도: <span th:text="|${pet.minTemp}~${pet.maxTemp}°C|">정보 없음</span>
                    </p>
                    <p>
                        활동량: <span th:text="${pet.activityLevel}">정보 없음</span>
                    </p>
                    <p>
                        더위 민감도: <span th:text="${pet.heatSensitive == 'Y' ? '민감' : '보통'}"></span>
                    </p>
                    <p>
                        추위 민감도: <span th:text="${pet.coldSensitive == 'Y' ? '민감' : '보통'}"></span>
                    </p>
                    <p>
                        크기: <span th:text="${pet.dogSize}"></span>
                    </p>
                </div>
                
                <hr class="my-4">
                
                <h4>알림 시간 설정</h4>
                <form id="notification-time-form">
                    <p>요일별 시간을 선택해주세요:</p>
                    <div id="day-time-options">
                        <div class="d-flex align-items-center mb-2">
                            <label class="form-label mb-0 day-label">월요일</label>
                            <span class="ms-2 me-3 current-time-display" data-day="mon">설정 안됨</span>
                            <select class="form-select time-select" data-day="mon">
                                <option value="">알림 안 받기</option>
                                <th:block th:each="hour : ${#numbers.sequence(5, 24)}">
                                    <option th:value="|${hour}:00|" th:text="|${hour}시|"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label class="form-label mb-0 day-label">화요일</label>
                            <span class="ms-2 me-3 current-time-display" data-day="tue">설정 안됨</span>
                            <select class="form-select time-select" data-day="tue">
                                <option value="">알림 안 받기</option>
                                <th:block th:each="hour : ${#numbers.sequence(5, 24)}">
                                    <option th:value="|${hour}:00|" th:text="|${hour}시|"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label class="form-label mb-0 day-label">수요일</label>
                            <span class="ms-2 me-3 current-time-display" data-day="wed">설정 안됨</span>
                            <select class="form-select time-select" data-day="wed">
                                <option value="">알림 안 받기</option>
                                <th:block th:each="hour : ${#numbers.sequence(5, 24)}">
                                    <option th:value="|${hour}:00|" th:text="|${hour}시|"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label class="form-label mb-0 day-label">목요일</label>
                            <span class="ms-2 me-3 current-time-display" data-day="thu">설정 안됨</span>
                            <select class="form-select time-select" data-day="thu">
                                <option value="">알림 안 받기</option>
                                <th:block th:each="hour : ${#numbers.sequence(5, 24)}">
                                    <option th:value="|${hour}:00|" th:text="|${hour}시|"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label class="form-label mb-0 day-label">금요일</label>
                            <span class="ms-2 me-3 current-time-display" data-day="fri">설정 안됨</span>
                            <select class="form-select time-select" data-day="fri">
                                <option value="">알림 안 받기</option>
                                <th:block th:each="hour : ${#numbers.sequence(5, 24)}">
                                    <option th:value="|${hour}:00|" th:text="|${hour}시|"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label class="form-label mb-0 day-label">토요일</label>
                            <span class="ms-2 me-3 current-time-display" data-day="sat">설정 안됨</span>
                            <select class="form-select time-select" data-day="sat">
                                <option value="">알림 안 받기</option>
                                <th:block th:each="hour : ${#numbers.sequence(5, 24)}">
                                    <option th:value="|${hour}:00|" th:text="|${hour}시|"></option>
                                </th:block>
                            </select>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <label class="form-label mb-0 day-label">일요일</label>
                            <span class="ms-2 me-3 current-time-display" data-day="sun">설정 안됨</span>
                            <select class="form-select time-select" data-day="sun">
                                <option value="">알림 안 받기</option>
                                <th:block th:each="hour : ${#numbers.sequence(5, 24)}">
                                    <option th:value="|${hour}:00|" th:text="|${hour}시|"></option>
                                </th:block>
                            </select>
                        </div>
                    </div>
                    <input type="hidden" id="notificationSchedule" name="notificationSchedule" />
                    <button type="submit" class="btn btn-secondary mt-3">시간 설정하기</button>
                </form>
            </div>
        </div>
    </th:block>
</body>

<th:block layout:fragment="jsScripts">
    <script th:inline="javascript">
    /*<![CDATA[*/
        const VAPID_PUBLIC_KEY = /*[[${vapidPublicKey}]]*/ 'VAPID_PUBLIC_KEY_NOT_FOUND';
    	const MEMBER_CODE = /*[[${mbrCd}]]*/ -1;

        const subscribeButton = document.getElementById('toggle-subscribe-button');
        const statusText = document.getElementById('subscription-status');
        const notificationTimeForm = document.getElementById('notification-time-form');
        const hiddenScheduleInput = document.getElementById('notificationSchedule');

        // 유틸리티 함수
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // 알림 구독 상태를 확인하고 버튼을 업데이트하는 함수
        async function updateButtonStatus() {
            try {
                statusText.textContent = "알림 상태를 확인 중입니다...";
                subscribeButton.disabled = true;

                const response = await fetch(`/api/push/status?mbrCd=${MEMBER_CODE}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const isActive = data.isActive;
                    
                    if (isActive) {
                        statusText.textContent = "현재 알림을 구독 중입니다.";
                        subscribeButton.textContent = "알림 구독 취소";
                        subscribeButton.className = "btn btn-danger mt-3";
                        subscribeButton.removeEventListener('click', subscribeUserToPush);
                        subscribeButton.addEventListener('click', unsubscribeUser);
                    } else {
                        statusText.textContent = "현재 알림 구독이 되어 있지 않습니다.";
                        subscribeButton.textContent = "알림 구독하기";
                        subscribeButton.className = "btn btn-primary mt-3";
                        subscribeButton.removeEventListener('click', unsubscribeUser);
                        subscribeButton.addEventListener('click', subscribeUserToPush);
                    }
                } else {
                    statusText.textContent = "알림 상태를 불러오는 데 실패했습니다. 다시 시도해주세요.";
                    console.error('API 응답 실패:', response.status);
                }
            } catch (error) {
                statusText.textContent = "네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
                console.error("알림 상태 확인 중 오류 발생:", error);
            } finally {
                subscribeButton.disabled = false;
            }
        }

        // 서비스 워커 등록
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            navigator.serviceWorker.register('/service-worker.js')
                .then(function(reg) {
                    console.log('서비스 워커가 성공적으로 등록되었습니다.', reg);
                })
                .catch(function(err) {
                    console.error('서비스 워커 등록 실패:', err);
                });
        }

        // 구독 시작 로직
        async function subscribeUserToPush() {
            try {
                const reg = await navigator.serviceWorker.ready;
                const subscription = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });

                // 백엔드에 구독 정보 전송
                const responseText = await sendSubscriptionToBackend(subscription);
                if (responseText === 'success') {
                    alert("알림 구독이 완료되었습니다!");
                } else {
                    alert("알림 구독에 실패했습니다. 다시 시도해주세요.");
                }
                updateButtonStatus();

            } catch (err) {
                console.error('푸시 알림 구독 실패:', err);
                alert("알림 구독에 실패했습니다. 브라우저 설정에서 알림을 허용해주세요.");
                updateButtonStatus();
            }
        }
        
        // 구독 취소 로직
        async function unsubscribeUser() {
		    try {
		        const response = await fetch('/api/push/unsubscribe', {
		            method: 'POST',
		            headers: { 'Content-Type': 'application/json' },
		            body: JSON.stringify(MEMBER_CODE)
		        });
		
		        if (response.ok) {
		            alert("알림이 취소되었습니다.");
		        } else {
		            alert("알림 취소에 실패했습니다.");
		        }
		        updateButtonStatus();
		    } catch (err) {
		        console.error("알림 취소 실패:", err);
		    }
		}

        // 백엔드로 구독 정보 전송
        async function sendSubscriptionToBackend(subscription) {
            const dto = {
                endpoint: subscription.endpoint,
                p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
            };
            try {
                const response = await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                });
                return response.text();
            } catch (error) {
                console.error('네트워크 오류:', error);
                return 'fail';
            }
        }
        
        // 알림 스케줄을 백엔드에서 불러와 UI에 적용
        async function loadNotificationSchedule() {
            try {
                const response = await fetch(`/api/push/schedule?mbrCd=${MEMBER_CODE}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.notificationSchedule) {
                        // 백엔드에서 이미 객체로 변환되어 왔으므로, JSON.parse()를 제거하고 바로 사용합니다.
                        const savedSchedule = data.notificationSchedule;
                        
                        for (const day in savedSchedule) {
                            const selectElement = document.querySelector(`.time-select[data-day="${day}"]`);
                            const displayElement = document.querySelector(`.current-time-display[data-day="${day}"]`);
                            if (selectElement) {
                                selectElement.value = savedSchedule[day];
                            }
                            if (displayElement) {
                                displayElement.textContent = savedSchedule[day];
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('알림 스케줄 로딩 실패:', error);
            }
        }

        // 폼 제출 이벤트 리스너
        notificationTimeForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const notificationSchedule = {};
            const timeSelects = document.querySelectorAll('.time-select');
            
            timeSelects.forEach(select => {
                const day = select.getAttribute('data-day');
                const time = select.value;
                if (time) {
                    notificationSchedule[day] = time;
                }
            });

            hiddenScheduleInput.value = JSON.stringify(notificationSchedule);

            const payload = {
                mbrCd: MEMBER_CODE,
                notificationSchedule: hiddenScheduleInput.value
            };

            try {
                const response = await fetch('/api/push/set-time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.text();
                if (result === 'success') {
                    alert('알림 시간이 성공적으로 설정되었습니다!');
                    await loadNotificationSchedule();
                } else {
                    alert('알림 시간 설정에 실패했습니다.');
                }
            } catch (error) {
                console.error('알림 시간 설정 오류:', error);
                alert('네트워크 오류가 발생했습니다.');
            }
        });
        
        // 페이지 로드 시 초기 상태 설정
        document.addEventListener('DOMContentLoaded', async () => {
            await updateButtonStatus();
            await loadNotificationSchedule();
        });
    /*]]>*/
    </script>
</th:block>
</html>