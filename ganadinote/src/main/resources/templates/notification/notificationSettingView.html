<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainLayoutView}">
<head>
    <meta charset="UTF-8">
    <title>알림 설정</title>
</head>
<body>
    <th:block layout:fragment="contents">
        <div class="container my-5">
            <h1 class="text-center mb-4">알림 설정</h1>
            <div class="card p-4">
                <p id="subscription-status">알림 상태를 확인 중입니다...</p>
                <button id="toggle-subscribe-button" class="btn btn-primary mt-3" disabled>로딩 중...</button>
                
                <hr class="my-4">
                
                <h4>강아지별 산책 정보</h4>
                <div th:each="pet : ${pets}" th:if="${pet}" class="border p-3 mb-3">
                    <h5 th:text="${pet.petName}">강아지 이름</h5>
                    <p>
                        <span th:text="${pet.petBreed}">품종</span>, 
                        <span th:text="${pet.petWeight}">체중</span>kg
                    </p>
                    <p>
                        적정 온도: <span th:text="|${pet.minTemp}~${pet.maxTemp}°C|">정보 없음</span>
                    </p>
                    <p>
                        활동량: <span th:text="${pet.activityLevel}">정보 없음</span>
                    </p>
                    <p>
                        더위 민감도: <span th:text="${pet.heatSensitive == 'Y' ? '민감' : '보통'}"></span>
                    </p>
                    <p>
                        추위 민감도: <span th:text="${pet.coldSensitive == 'Y' ? '민감' : '보통'}"></span>
                    </p>
                    <p>
                        크기: <span th:text="${pet.dogSize}"></span>
                    </p>
                </div>
                
                <hr class="my-4">
                
                <h4>알림 시간 일괄 설정</h4>
                <form id="notification-time-form">
                    <div class="mb-3">
                        <label for="notificationTime" class="form-label">알림 시간</label>
                        <select class="form-select" id="notificationTime" required>
                            <option value="">시간을 선택하세요</option>
                            <th:block th:each="hour : ${#numbers.sequence(5, 24)}">
                                <option th:value="${hour}" th:text="|${hour}시|"></option>
                            </th:block>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-secondary">시간 설정하기</button>
                </form>
            </div>
        </div>
    </th:block>
</body>

<th:block layout:fragment="jsScripts">
    <script th:inline="javascript">
    /*<![CDATA[*/
        const VAPID_PUBLIC_KEY = /*[[${vapidPublicKey}]]*/ 'VAPID_PUBLIC_KEY_NOT_FOUND';
    	const MEMBER_CODE = /*[[${mbrCd}]]*/ -1;

        const subscribeButton = document.getElementById('toggle-subscribe-button');
        const statusText = document.getElementById('subscription-status');
        
        // 유틸리티 함수
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // 알림 구독 상태를 확인하고 버튼을 업데이트하는 함수
        async function updateButtonStatus() {
            try {
                statusText.textContent = "알림 상태를 확인 중입니다...";
                subscribeButton.disabled = true;

                const response = await fetch(`/api/push/status?mbrCd=${MEMBER_CODE}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const isActive = data.isActive;
                    
                    if (isActive) {
                        statusText.textContent = "현재 알림을 구독 중입니다.";
                        subscribeButton.textContent = "알림 구독 취소";
                        subscribeButton.className = "btn btn-danger mt-3";
                        subscribeButton.removeEventListener('click', subscribeUserToPush);
                        subscribeButton.addEventListener('click', unsubscribeUser);
                    } else {
                        statusText.textContent = "현재 알림 구독이 되어 있지 않습니다.";
                        subscribeButton.textContent = "알림 구독하기";
                        subscribeButton.className = "btn btn-primary mt-3";
                        subscribeButton.removeEventListener('click', unsubscribeUser);
                        subscribeButton.addEventListener('click', subscribeUserToPush);
                    }
                } else {
                    statusText.textContent = "알림 상태를 불러오는 데 실패했습니다. 다시 시도해주세요.";
                    console.error('API 응답 실패:', response.status);
                }
            } catch (error) {
                statusText.textContent = "네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
                console.error("알림 상태 확인 중 오류 발생:", error);
            } finally {
                subscribeButton.disabled = false;
            }
        }

        // 서비스 워커 등록
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            navigator.serviceWorker.register('/serviceWorker.js')
                .then(function(reg) {
                    console.log('서비스 워커가 성공적으로 등록되었습니다.', reg);
                })
                .catch(function(err) {
                    console.error('서비스 워커 등록 실패:', err);
                });
        }

        // 구독 시작 로직
        async function subscribeUserToPush() {
            try {
                const reg = await navigator.serviceWorker.ready;
                const subscription = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });

                // 백엔드에 구독 정보 전송
                const responseText = await sendSubscriptionToBackend(subscription);
                if (responseText === 'success') {
                    alert("알림 구독이 완료되었습니다!");
                } else {
                    alert("알림 구독에 실패했습니다. 다시 시도해주세요.");
                }
                updateButtonStatus();

            } catch (err) {
                console.error('푸시 알림 구독 실패:', err);
                alert("알림 구독에 실패했습니다. 브라우저 설정에서 알림을 허용해주세요.");
                updateButtonStatus();
            }
        }
        
        // 구독 취소 로직
        async function unsubscribeUser() {
		    try {
		        const response = await fetch('/api/push/unsubscribe', {
		            method: 'POST',
		            headers: { 'Content-Type': 'application/json' },
		            body: JSON.stringify(MEMBER_CODE) // 회원 코드를 JSON 형식으로 전송
		        });
		
		        if (response.ok) {
		            alert("알림이 취소되었습니다.");
		        } else {
		            alert("알림 취소에 실패했습니다.");
		        }
		        updateButtonStatus();
		    } catch (err) {
		        console.error("알림 취소 실패:", err);
		    }
		}


        // 백엔드로 구독 정보 전송
        async function sendSubscriptionToBackend(subscription) {
            const dto = {
                endpoint: subscription.endpoint,
                p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
            };
            try {
                const response = await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dto)
                });
                return response.text();
            } catch (error) {
                console.error('네트워크 오류:', error);
                return 'fail';
            }
        }

        // 알림 시간 설정 함수
        async function setNotificationTime() {
            const notificationTime = document.getElementById('notificationTime').value;

            // 선택값 유효성 검사 (첫 번째 '시간을 선택하세요' 옵션)
            if (!notificationTime) {
                alert("알림 시간을 선택해주세요.");
                return;
            }

            const payload = {
                mbrCd: MEMBER_CODE,
                notificationTime: notificationTime + ":00" // 서버에 시간:분 형식으로 보내기 위해 ":00" 추가
            };

            try {
                const response = await fetch('/api/push/set-time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.text();
                if (result === 'success') {
                    alert('알림 시간이 성공적으로 설정되었습니다!');
                } else {
                    alert('알림 시간 설정에 실패했습니다.');
                }
            } catch (error) {
                console.error('알림 시간 설정 오류:', error);
                alert('네트워크 오류가 발생했습니다.');
            }
        }

        // 폼 제출 이벤트 리스너
        document.getElementById('notification-time-form').addEventListener('submit', function(event) {
            event.preventDefault();
            setNotificationTime();
        });
        
        // 페이지 로드 시 초기 상태 설정
        document.addEventListener('DOMContentLoaded', updateButtonStatus);
    /*]]>*/
    </script>
</th:block>
</html>