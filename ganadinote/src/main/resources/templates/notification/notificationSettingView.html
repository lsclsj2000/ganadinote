<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainLayoutView}">
<head>
    <meta charset="UTF-8">
    <title>알림 설정</title>
</head>
<body>
    <th:block layout:fragment="contents">
        <div class="container my-5">
            <h1 class="text-center mb-4">알림 설정</h1>
            <div class="card p-4">
                <p id="subscription-status">알림 상태를 확인 중입니다...</p>
                <button id="toggle-subscribe-button" class="btn btn-primary mt-3" disabled>로딩 중...</button>
            </div>
        </div>
    </th:block>

    <script th:inline="javascript">
    /*<![CDATA[*/
        const VAPID_PUBLIC_KEY = /*[[${vapidPublicKey}]]*/ '';
        const MEMBER_CODE = /*[[${mbrCd}]]*/ '1';

        const subscribeButton = document.getElementById('toggle-subscribe-button');
        const statusText = document.getElementById('subscription-status');
        
        // 유틸리티 함수
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // 알림 구독 상태를 확인하고 버튼을 업데이트하는 함수
        async function updateButtonStatus() {
            try {
                // 알림 상태 텍스트를 '확인 중'으로 변경하고 버튼을 비활성화
                statusText.textContent = "알림 상태를 확인 중입니다...";
                subscribeButton.disabled = true;

                const response = await fetch(`/api/push/status?mbrCd=${MEMBER_CODE}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const isActive = data.isActive;
                    
                    if (isActive) {
                        statusText.textContent = "현재 알림을 구독 중입니다.";
                        subscribeButton.textContent = "알림 구독 취소";
                        subscribeButton.className = "btn btn-danger mt-3";
                        subscribeButton.removeEventListener('click', subscribeUserToPush);
                        subscribeButton.addEventListener('click', unsubscribeUser);
                    } else {
                        statusText.textContent = "현재 알림 구독이 되어 있지 않습니다.";
                        subscribeButton.textContent = "알림 구독하기";
                        subscribeButton.className = "btn btn-primary mt-3";
                        subscribeButton.removeEventListener('click', unsubscribeUser);
                        subscribeButton.addEventListener('click', subscribeUserToPush);
                    }
                } else {
                    // 응답이 실패하면 로딩 실패 메시지 표시
                    statusText.textContent = "알림 상태를 불러오는 데 실패했습니다. 다시 시도해주세요.";
                    console.error('API 응답 실패:', response.status);
                }
            } catch (error) {
                statusText.textContent = "네트워크 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
                console.error("알림 상태 확인 중 오류 발생:", error);
            } finally {
                // 로딩이 완료되면 버튼을 활성화
                subscribeButton.disabled = false;
            }
        }

        // 서비스 워커 등록
        if ('serviceWorker' in navigator && 'PushManager' in window) {
            navigator.serviceWorker.register('/serviceWorker.js')
                .then(function(reg) {
                    console.log('서비스 워커가 성공적으로 등록되었습니다.', reg);
                })
                .catch(function(err) {
                    console.error('서비스 워커 등록 실패:', err);
                });
        }

        // 구독 시작 로직
        async function subscribeUserToPush() {
            try {
                const reg = await navigator.serviceWorker.ready;
                const subscription = await reg.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });

                // 백엔드에 구독 정보 전송
                const responseText = await sendSubscriptionToBackend(subscription);
                if (responseText === 'success') {
                    alert("알림 구독이 완료되었습니다!");
                } else {
                    alert("알림 구독에 실패했습니다. 다시 시도해주세요.");
                }
                updateButtonStatus(); // 상태를 다시 확인하여 버튼 업데이트

            } catch (err) {
                console.error('푸시 알림 구독 실패:', err);
                alert("알림 구독에 실패했습니다. 브라우저 설정에서 알림을 허용해주세요.");
                updateButtonStatus();
            }
        }
        
        // 구독 취소 로직
        async function unsubscribeUser() {
            try {
                const response = await fetch('/api/push/unsubscribe', {
                    method: 'POST'
                });
                if (response.ok) {
                    alert("알림이 취소되었습니다.");
                } else {
                    alert("알림 취소에 실패했습니다.");
                }
                updateButtonStatus(); // 상태를 다시 확인하여 버튼 업데이트
            } catch (err) {
                console.error("알림 취소 실패:", err);
            }
        }

        // 백엔드로 구독 정보 전송
        async function sendSubscriptionToBackend(subscription) {
            const dto = {
                endpoint: subscription.endpoint,
                p256dh: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('p256dh')))),
                auth: btoa(String.fromCharCode.apply(null, new Uint8Array(subscription.getKey('auth'))))
            };
            try {
                const response = await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dto)
                });
                return response.text();
            } catch (error) {
                console.error('네트워크 오류:', error);
                return 'fail';
            }
        }
        
        // 페이지 로드 시 초기 상태 설정
        document.addEventListener('DOMContentLoaded', updateButtonStatus);
    /*]]>*/
    </script>
</body>
</html>