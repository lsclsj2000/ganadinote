<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainLayoutView}">

<head>
    <title>댕댕이 투두리스트</title>
    <link rel="stylesheet" href="/assets/css/todo/todoList.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<div layout:fragment="contents">
    <div class="todo-list-page">

        <div class="header-top">
            <span class="material-icons menu-icon">menu</span>
            <h2>오늘 할 일</h2>
        </div>
        <div class="pet-profiles-wrapper">
            <div class="pet-profiles">
                <div class="pet-profile" data-pet-id="all">
                    <img src="/images/imokaycat.jpg" alt="견주 프로필" class="profile-pic">
                    <span>me</span>
                </div>
                <div th:each="pet : ${pets}" class="pet-profile" th:data-pet-id="${pet.petCd}">
                    <img th:src="${pet.petProfileImgUrl != null ? pet.petProfileImgUrl : '/images/default-pet.jpg'}"
                         th:alt="${pet.petName} + ' 프로필'" class="profile-pic">
                    <span th:text="${pet.petName}">반려견 이름</span>
                </div>
            </div>
        </div>

        <div class="calendar-wrapper">
            <div class="calendar-header">
                <button id="prevMonthBtn">&lt;</button>
                <span id="currentMonthYear">2025년 8월</span>
                <button id="nextMonthBtn">&gt;</button>
            </div>
            <div class="calendar-grid"></div>
        </div>
        <button class="add-todo-btn" onclick="location.href='/todo/addView'">할 일 추가</button>

        <div class="modal" id="todoModal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3 id="modal-date"></h3>
                <ul id="modal-todo-list"></ul>
                <button id="add-new-todo-btn">할 일 추가하기</button>
            </div>
        </div>

        <script th:inline="javascript">
        /* <![CDATA[ */
            const todosFromServer = /*[[${todos}]]*/ [];
            const petsFromServer = /*[[${pets}]]*/ [];

            document.addEventListener('DOMContentLoaded', () => {
                let currentSelectedPetId = 'all';
                let petProfileElements;

                const calendarGrid = document.querySelector('.calendar-grid');
                const currentMonthYearSpan = document.getElementById('currentMonthYear');
                const prevMonthBtn = document.getElementById('prevMonthBtn');
                const nextMonthBtn = document.getElementById('nextMonthBtn');
                const modal = document.getElementById('todoModal');
                const modalDate = document.getElementById('modal-date');
                const closeBtn = document.querySelector('.close-btn');
                let currentDate = new Date();

                function setupPetProfileClickEvents() {
                    petProfileElements = document.querySelectorAll('.pet-profile');
                    petProfileElements.forEach(profile => {
                        profile.addEventListener('click', () => {
                            const petId = profile.getAttribute('data-pet-id');
                            currentSelectedPetId = petId;
                            petProfileElements.forEach(p => p.classList.remove('active'));
                            profile.classList.add('active');
                            renderCalendar();
                        });
                    });
                }

                function renderCalendar() {
                    const memberPetIds = petsFromServer.map(p => p.petCd);
                    const filteredTodos = todosFromServer.filter(todo => {
                        if (currentSelectedPetId === 'all') {
                            return memberPetIds.includes(todo.petCd);
                        }
                        return todo.petCd == currentSelectedPetId;
                    });

                    const todosByDate = {};
                    filteredTodos.forEach(todo => {
                        const date = todo.todoScheduledDt.substring(0, 10);
                        if (!todosByDate[date]) {
                            todosByDate[date] = [];
                        }
                        todosByDate[date].push(todo);
                    });
                    
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    currentMonthYearSpan.textContent = `${year}년 ${month + 1}월`;
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const lastDateOfMonth = new Date(year, month + 1, 0).getDate();
                    calendarGrid.innerHTML = `<div class="day-header">일</div> <div class="day-header">월</div><div class="day-header">화</div> <div class="day-header">수</div><div class="day-header">목</div> <div class="day-header">금</div><div class="day-header">토</div>`;
                    for (let i = 0; i < firstDayOfMonth; i++) {
                        calendarGrid.insertAdjacentHTML('beforeend', `<div class="day empty"></div>`);
                    }
                    for (let i = 1; i <= lastDateOfMonth; i++) {
                        const day = document.createElement('div');
                        day.classList.add('day');
                        day.textContent = i;
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        day.setAttribute('data-date', dateStr);
                        const todosForThisDay = todosByDate[dateStr] || [];
                        if (todosForThisDay.length > 0) {
                            day.classList.add('has-todos');
                            todosForThisDay.slice(0, 2).forEach(todo => {
                                const todoBlock = document.createElement('div');
                                todoBlock.classList.add('todo-block');
                                if (todo.todoIsCompleted) {
                                    todoBlock.classList.add('completed');
                                }
                                todoBlock.textContent = todo.todoTitle;
                                day.appendChild(todoBlock);
                            });
                        }

                        day.addEventListener('click', () => {
                            const date = day.getAttribute('data-date');
                            const modalTodoList = document.getElementById('modal-todo-list');
                            const modalTitle = document.getElementById('modal-date');
                            const addNewTodoBtn = document.getElementById('add-new-todo-btn');
                            
                            modalTitle.textContent = date;
                            addNewTodoBtn.style.display = 'block';
                            modalTodoList.innerHTML = '';
                            
                            // [수정!] Spring Security가 비활성화 되어 CSRF 토큰이 필요 없을 수 있지만,
                            // 나중에 다시 활성화할 경우를 대비해 코드를 남겨두는 것이 좋습니다.
                            // 만약 meta 태그가 없다면 이 부분은 null이 되어도 괜찮습니다.
                            const csrfMeta = document.querySelector("meta[name='_csrf']");
                            const token = csrfMeta ? csrfMeta.getAttribute("content") : null;

                            if (todosForThisDay.length > 0) {
                                todosForThisDay.forEach(todo => {
                                    const li = document.createElement('li');
                                    li.id = `todo-item-${todo.todoCd}`;
                                    if (todo.todoIsCompleted) {
                                        li.classList.add('completed');
                                    }

                                    const wrapper = document.createElement('div');
                                    wrapper.classList.add('todo-item-wrapper');

                                    // [추가 1] 체크박스 생성
                                    const checkbox = document.createElement('input');
                                    checkbox.type = 'checkbox';
                                    checkbox.checked = todo.todoIsCompleted;
                                    checkbox.classList.add('todo-checkbox');
                                    checkbox.onchange = () => {
                                        toggleTodoComplete(todo.todoCd, token);
                                    };

                                    const todoText = document.createElement('span');
                                    const petInfo = petsFromServer.find(p => p.petCd === todo.petCd);
                                    const petName = petInfo ? petInfo.petName : '알 수 없음';
                                    todoText.textContent = `[${petName}] ${todo.todoTitle}`;
                                    
                                    const deleteForm = document.createElement('form');
                                    deleteForm.action = '/todo/delete';
                                    deleteForm.method = 'post';
                                    deleteForm.onsubmit = () => confirm('정말로 이 할 일을 삭제하시겠습니까?');

                                    const hiddenInput = document.createElement('input');
                                    hiddenInput.type = 'hidden';
                                    hiddenInput.name = 'todoCd';
                                    hiddenInput.value = todo.todoCd;

                                    deleteForm.appendChild(hiddenInput);

                                    const deleteButton = document.createElement('button');
                                    deleteButton.type = 'submit';
                                    deleteButton.textContent = '삭제';
                                    deleteButton.classList.add('delete-btn');
                                    deleteForm.appendChild(deleteButton);

                                    const editButton = document.createElement('button');
                                    editButton.textContent = '수정';
                                    editButton.classList.add('edit-btn');
                                    editButton.onclick = () => {
                                        showEditForm(todo);
                                    };
                                    
                                    // wrapper에 요소들을 순서대로 추가 (체크박스가 맨 앞)
                                    wrapper.appendChild(checkbox);
                                    wrapper.appendChild(todoText);
                                    wrapper.appendChild(editButton);
                                    wrapper.appendChild(deleteForm);
                                    
                                    li.appendChild(wrapper);
                                    modalTodoList.appendChild(li);
                                });
                            } else {
                                modalTodoList.innerHTML = '<li>등록된 할 일이 없습니다.</li>';
                            }
                            modal.classList.add('show');
                        });
                        calendarGrid.appendChild(day);
                    }
                }
                
                function showEditForm(todo) {
                    // ... (수정 폼 보여주는 함수는 변경 없음)
                }
                
                // [추가 2] 서버에 완료 상태 변경을 요청하는 AJAX 함수
                function toggleTodoComplete(todoCd, csrfToken) {
                    const formData = new FormData();
                    formData.append('todoCd', todoCd);

                    fetch('/api/todo/toggleComplete', {
                        method: 'POST',
                        headers: {
                            // Spring Security가 비활성화 상태에서는 CSRF 헤더가 필요 없습니다.
                            // 'X-CSRF-TOKEN': csrfToken 
                        },
                        body: new URLSearchParams(formData) // 폼 데이터를 URL 인코딩 형식으로 변환
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('서버 처리 실패');
                        return response.text();
                    })
                    .then(data => {
                        if (data === 'ok') {
                            const todoItem = document.getElementById(`todo-item-${todoCd}`);
                            todoItem.classList.toggle('completed');

                            const targetTodo = todosFromServer.find(t => t.todoCd === todoCd);
                            if (targetTodo) {
                                targetTodo.todoIsCompleted = !targetTodo.todoIsCompleted;
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('할 일 상태 변경에 실패했습니다.');
                        const checkbox = document.querySelector(`#todo-item-${todoCd} .todo-checkbox`);
                        if(checkbox) checkbox.checked = !checkbox.checked;
                    });
                }
                
                renderCalendar(); 
                setupPetProfileClickEvents();
                document.querySelector('.pet-profile[data-pet-id="all"]').classList.add('active');

                prevMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });
                nextMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });
                
                closeBtn.addEventListener('click', () => modal.classList.remove('show'));
                
                window.addEventListener('click', (event) => {
                    if (event.target === modal) modal.classList.remove('show');
                });
            });
        /* ]]> */
        </script>

        <div class="ad-section">
            <p>광고 영역</p>
        </div>
    </div>
</div>
</html>