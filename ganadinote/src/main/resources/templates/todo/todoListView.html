<!DOCTYPE html>
<!-- [변경 없음] 레이아웃 설정은 그대로입니다. -->
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainLayoutView}">

<head>
    <title>댕댕이 투두리스트</title>
    <link rel="stylesheet" href="/assets/css/todo/todoList.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<div layout:fragment="contents">
    <div class="container">
        <!-- [변경 없음] header, main의 기본 구조는 그대로입니다. -->
        <header>
            <!-- ... (기존 header HTML 코드 생략 없이 그대로) ... -->
            <div class="header-top">
                <span class="material-icons menu-icon">menu</span>
                <h2>오늘 할 일</h2>
            </div>
            <div class="pet-profiles-wrapper">
                <div class="pet-profiles">
                    <div class="pet-profile" data-pet-id="all">
                        <img src="/images/imokaycat.jpg" alt="견주 프로필" class="profile-pic">
                        <span>me</span>
                    </div>
                    <div class="pet-profile" data-pet-id="ruby">
                        <img src="/images/루비.jpg" alt="루비 프로필" class="profile-pic">
                        <span>루비</span>
                    </div>
                    <div class="pet-profile" data-pet-id="jjongi">
                        <img src="/images/쫑이.jpg" alt="쫑이 프로필" class="profile-pic">
                        <span>쫑이</span>
                    </div>
                    <div class="pet-profile" data-pet-id="boksil">
                        <img src="/images/복실.jpg" alt="복실 프로필" class="profile-pic">
                        <span>복실</span>
                    </div>
                </div>
            </div>
            <div class="date-navigation">
                <button>&lt;</button>
                <span>2025년 8월 18일</span>
                <button>&gt;</button>
            </div>
        </header>

        <main>
            <div class="calendar-wrapper">
                <div class="calendar-header">
                    <button id="prevMonthBtn">&lt;</button>
                    <span id="currentMonthYear">2025년 8월</span>
                    <button id="nextMonthBtn">&gt;</button>
                </div>
                <div class="calendar-grid">
                    <!-- JavaScript가 이 부분을 동적으로 채울 것입니다. -->
                </div>
            </div>
            <button class="add-todo-btn" onclick="location.href='/todo/addView'">할 일 추가</button>
        </main>

        <!-- [변경 없음] 모달창 구조는 그대로입니다. -->
        <div class="modal" id="todoModal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3 id="modal-date"></h3>
                <ul id="modal-todo-list">
                    <!-- JavaScript로 할 일 목록이 여기에 들어갈 예정 -->
                </ul>
                <button id="add-new-todo-btn">할 일 추가하기</button>
            </div>
        </div>
        
        <!-- ====================================================================== -->
        <!-- ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ 이 부분이 핵심입니다 ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼ -->
        <!-- ====================================================================== -->
        
        <!-- [변경점 1] script 태그에 th:inline="javascript" 속성을 추가합니다. -->
        <script th:inline="javascript">
        /* <![CDATA[ */ // Thymeleaf와 JavaScript 문법 충돌을 방지하기 위한 코드입니다.

            // [변경점 2] 컨트롤러가 Model에 담아 보낸 'todos' 데이터를 JavaScript 변수로 가져옵니다.
            const todosFromServer = /*[[${todos}]]*/ [];

            document.addEventListener('DOMContentLoaded', () => {
                const calendarGrid = document.querySelector('.calendar-grid');
                const currentMonthYearSpan = document.getElementById('currentMonthYear');
                const prevMonthBtn = document.getElementById('prevMonthBtn');
                const nextMonthBtn = document.getElementById('nextMonthBtn');
                const modal = document.getElementById('todoModal');
                const modalDate = document.getElementById('modal-date');
                const closeBtn = document.querySelector('.close-btn');

                let currentDate = new Date();

                // [변경점 3] 서버에서 받은 데이터를 날짜별로 쉽게 찾을 수 있도록 가공합니다.
                // 예: { "2025-08-21": [todo1, todo2], "2025-08-22": [todo3] }
                const todosByDate = {};
                todosFromServer.forEach(todo => {
                    // "2025-08-21T10:00:00" 같은 형식을 "2025-08-21"로 자릅니다.
                    const date = todo.todoScheduledDt.substring(0, 10);
                    if (!todosByDate[date]) {
                        todosByDate[date] = [];
                    }
                    todosByDate[date].push(todo);
                });

                // 달력 생성 함수
                function renderCalendar() {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    currentMonthYearSpan.textContent = `${year}년 ${month + 1}월`;

                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const lastDateOfMonth = new Date(year, month + 1, 0).getDate();

                    calendarGrid.innerHTML = `
                        <div class="day-header">일</div> <div class="day-header">월</div>
                        <div class="day-header">화</div> <div class="day-header">수</div>
                        <div class="day-header">목</div> <div class="day-header">금</div>
                        <div class="day-header">토</div>
                    `;

                    for (let i = 0; i < firstDayOfMonth; i++) {
                        calendarGrid.insertAdjacentHTML('beforeend', `<div class="day empty"></div>`);
                    }

                    for (let i = 1; i <= lastDateOfMonth; i++) {
                        const day = document.createElement('div');
                        day.classList.add('day');
                        day.textContent = i;
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        day.setAttribute('data-date', dateStr);
                        
                        // [변경점 4] 해당 날짜에 할 일이 있는지 확인하고, 있다면 화면에 표시합니다.
                        const todosForThisDay = todosByDate[dateStr] || [];
                        if (todosForThisDay.length > 0) {
                            day.classList.add('has-todos');
                            todosForThisDay.slice(0, 2).forEach(todo => { // 최대 2개까지만 표시
                                const todoBlock = document.createElement('div');
                                todoBlock.classList.add('todo-block');
                                if (todo.todoIsCompleted) {
                                    todoBlock.classList.add('completed');
                                }
                                todoBlock.textContent = todo.todoTitle;
                                day.appendChild(todoBlock);
                            });
                        }
                        
                        // [변경점 5] 날짜 클릭 시, 하드코딩된 내용이 아닌 실제 데이터를 모달에 표시합니다.
                        day.addEventListener('click', () => {
                            const date = day.getAttribute('data-date');
                            modalDate.textContent = date;
                            const modalTodoList = document.getElementById('modal-todo-list');
                            modalTodoList.innerHTML = ''; // 기존 목록 초기화

                            if (todosForThisDay.length > 0) {
                                todosForThisDay.forEach(todo => {
                                    const li = document.createElement('li');
                                    li.textContent = `[${todo.petCd}번 댕댕이] ${todo.todoTitle}`;
                                    if (todo.todoIsCompleted) {
                                        li.classList.add('completed');
                                    }
                                    modalTodoList.appendChild(li);
                                });
                            } else {
                                modalTodoList.innerHTML = '<li>등록된 할 일이 없습니다.</li>';
                            }
                            modal.classList.add('show');
                        });

                        calendarGrid.appendChild(day);
                    }
                }

                renderCalendar();

                prevMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    renderCalendar();
                });

                nextMonthBtn.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    renderCalendar();
                });

                closeBtn.addEventListener('click', () => modal.classList.remove('show'));
                window.addEventListener('click', (event) => {
                    if (event.target === modal) modal.classList.remove('show');
                });
            });

        /* ]]> */
        </script>
        
        <footer>
            <p>광고 영역</p>
        </footer>
    </div>
</div>
</html>