<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/communityLayoutView}">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
	<title>ì»¤ë®¤ë‹ˆí‹°</title>
	<link th:href="@{/assets/css/bootstrap.css}" href="/assets/css/bootstrap.css" rel="stylesheet"/>
	<th:block layout:fragment="pageStyles">
		<style>
			.mobile-wrap {
				max-width: 460px;
				margin: auto;
			}

			.sticky-topbar {
				position: sticky;
				top: 0;
				border-bottom: 1px solid #eee;
				z-index: 1;
				padding: .5rem;
			}

			.sticky-topbar .d-flex {
				margin-bottom: .5rem;
			}

			.chip-scroll {
				overflow-x: auto;
				white-space: nowrap;
				-webkit-overflow-scrolling: touch;
				padding-bottom: .3rem;
				margin-bottom: .6rem;
			}

			.chip {
				display: inline-block;
				padding: .45rem .9rem;
				margin-right: .4rem;
				border: 1px solid #ddd;
				border-radius: 999px;
				font-size: .95rem;
				background: #f8f9fa;
			}

			.chip.active {
				background: #e9ecef;
				font-weight: 600;
			}

			.post-card {
				border-bottom: 1px solid #f1f1f1;
				padding: 20px 8px;
			}

			.fab {
				position: fixed;
				right: 16px;
				bottom: calc(var(--footer-h) + 16px);
				z-index: 1;
			}

			.card-text {
				font-size: 0.7rem;
				color: #6c757d;
			}

			.small {
				font-size: 0.7rem;
			}
		</style>
	</th:block>
</head>

<body>
	<th:block layout:fragment="contents">
		<div class="mobile-wrap">
			<!-- ìƒë‹¨ ê²€ìƒ‰ + ì •ë ¬ -->
			<div class="sticky-topbar p-2">
				<div class="d-flex gap-2">
				  <!-- â†“ ì •ë ¬ ëŒ€ì‹  ê²€ìƒ‰ëŒ€ìƒ -->
				  <select class="form-select form-select-sm" style="max-width:140px" name="qTarget">
				    <option value="title"  th:selected="${param.qTarget ?: 'title'} == 'title'">ì œëª©</option>
				    <option value="author" th:selected="${param.qTarget} == 'author'">ì‘ì„±ì</option>
				  </select>

				  <input type="search"
				         class="form-control form-control-sm"
				         name="q"
				         placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ í›„ Enter"
				         th:value="${param.q}">
				</div>
				<!-- ì¹´í…Œê³ ë¦¬ ì¹© -->
				<div class="chip-scroll mt-2 pb-1" id="catChips">
				  <button class="chip" type="button" data-cat="">ì „ì²´</button>
				  <button class="chip" type="button" data-cat="1">ë°œìêµ­ ì‚°ì±…ì½”ìŠ¤</button>
				  <button class="chip" type="button" data-cat="3">ë©ë© ì‡¼í•‘ë¦¬ë·°</button>
				  <button class="chip" type="button" data-cat="4">ë©ë© ìˆ˜ë‹¤ë°©</button>
				  <button class="chip" type="button" data-cat="5">ì‚°ì±…í¬ë£¨ ëª¨ì§‘í•´ìš”!</button>
				  <button class="chip" type="button" data-cat="2">ê°™ì´ê°€ìš” ìŠ¤íŒŸ</button>
				</div>
			</div>

			<!-- ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸ -->
			<div id="list">
				<div th:if="${#lists.isEmpty(post)}"
				       class="text-center text-muted py-4">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>

				  <!-- ëª©ë¡ ë Œë”ë§ -->
				  <div th:each="p : ${post}" class="post-card card mb-3">
				    <div class="card-body">
				      <a class="stretched-link"
				         th:href="@{/community/postDetail(postId=${p.postId})}"></a>

				      <span class="badge bg-secondary mb-3"
				            th:text="${p.categoryNm}">ì¹´í…Œê³ ë¦¬</span>

				      <h6 th:text="${p.postTtl}">ì œëª©</h6>

					  <p class="card-text text-truncate"
					     th:text="${p.postCtnt} ?: ''">ë¯¸ë¦¬ë³´ê¸°</p>

					 <div class="post-meta small text-muted">
					   <div th:text="${p.mbrNknm}">ì‘ì„±ì</div>
					   <div th:text="${#temporals.format(p.postRegDate, 'yyyy.MM.dd HH:mm')}">2025.08.26 18:45</div>
					   <div th:text="'ì¡°íšŒ ' + ${p.postViewCount}">ì¡°íšŒ 10</div>
					 </div>

				      <div class="d-flex justify-content-end gap-3 mt-2">
				        <span>ğŸ‘ <span th:text="${p.postLikeCount}">0</span></span>
				        <span>ğŸ’¬ <span th:text="${p.cmtCount}">0</span></span>
				      </div>
				    </div>
				  </div>
				</div>

			<!-- ë”ë³´ê¸° ë²„íŠ¼ -->
			<div class="p-3 text-center">
			  <button id="btnMore" class="btn btn-outline-secondary btn-sm w-100">ë”ë³´ê¸°</button>
			</div>
		</div>

		<!-- ìƒˆ ê¸€ ì“°ê¸° ë²„íŠ¼ -->
		<div class="fab">
			<a th:href="@{/community/addPost}" class="btn btn-primary rounded-pill px-3 py-2">ê¸€ì“°ê¸°</a>
		</div>
	</th:block>
	<th:block layout:fragment="pageScripts">
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<script>
		$(function(){
		  const $list    = $('#list');
		  const $btnMore = $('#btnMore');
		  const $chips   = $('#catChips');
		  const $q       = $('[name="q"]');
		  const $qTarget = $('[name="qTarget"]');

		  const usp = new URLSearchParams(location.search);

		  const state = {
		    size: 10,
		    offset: 0,
		    loading: false,
		    categoryId: usp.get('categoryId') || '',
		    q:        usp.get('q')        || '',
		    qTarget:  usp.get('qTarget')  || 'title'
		  };

		  // ì´ˆê¸° ì…ë ¥ê°’ ë°˜ì˜
		  if (state.q) $q.val(state.q);
		  $qTarget.val(state.qTarget);

		  function fmt(iso){
		    if(!iso) return '';
		    const v = typeof iso === 'string' ? iso.replace(' ', 'T') : iso;
		    const d = new Date(v);
		    if (isNaN(d)) return iso;
		    const z = n => String(n).padStart(2,'0');
		    return d.getFullYear()+'.'+z(d.getMonth()+1)+'.'+z(d.getDate())+' '+z(d.getHours())+':'+z(d.getMinutes());
		  }
		  function esc(s){
		    return (s ?? '').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
		  }
		  function renderPosts(posts){
		    if(!posts || posts.length===0){
		      return '<div class="text-center text-muted py-4">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
		    }
		    return posts.map(p => `
		      <div class="post-card card mb-3">
		        <div class="card-body">
		          <a class="stretched-link" href="/community/postDetail?postId=${esc(p.postId)}"></a>
		          <span class="badge bg-secondary mb-3">${esc(p.categoryNm || '')}</span>
		          <h6>${esc(p.postTtl || '')}</h6>
		          <p class="card-text text-truncate">${esc(p.postCtnt || '')}</p>
		          <div class="post-meta small text-muted">
		            <div>${esc(p.mbrNknm || '')}</div>
		            <div>${fmt(p.postRegDate)}</div>
		            <div>ì¡°íšŒ ${p.postViewCount ?? 0}</div>
		          </div>
		          <div class="d-flex justify-content-end gap-3 mt-2">
		            <span>ğŸ‘ ${p.postLikeCount ?? 0}</span>
		            <span>ğŸ’¬ ${p.cmtCount ?? 0}</span>
		          </div>
		        </div>
		      </div>`).join('');
		  }

		  function pushUrl(){
		    const u = new URL(location.href);
		    const p = u.searchParams;
		    if (state.categoryId) p.set('categoryId', state.categoryId); else p.delete('categoryId');
		    if (state.q)         p.set('q', state.q);                     else p.delete('q');
		    if (state.qTarget)   p.set('qTarget', state.qTarget);         else p.delete('qTarget');
		    history.replaceState(null, '', u.pathname + '?' + p.toString());
		  }

		  function fetchPosts(append){
		    if (state.loading) return;
		    state.loading = true;

		    if (!append){
		      state.offset = 0;
		      $list.html('<div class="text-center text-muted py-4">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>');
		    }

		    const params = { size: state.size, offset: state.offset };
		    if (state.categoryId) params.categoryId = state.categoryId;
		    if (state.q)         params.q = state.q.trim();
		    if (state.qTarget)   params.qTarget = state.qTarget;

		    $.getJSON('/community/api/list', params)
		      .done(function(posts){
		        if (append) $list.append(renderPosts(posts));
		        else $list.html(renderPosts(posts));
		        state.offset += (posts?.length || 0);
		        $btnMore.toggle((posts?.length || 0) === state.size);
		        pushUrl();
		      })
		      .fail(function(){
		        if (!append) $list.html('<div class="text-center text-danger py-4">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>');
		        $btnMore.hide();
		      })
		      .always(function(){ state.loading = false; });
		  }

		  function setActiveChip(cat){
		    const $all = $chips.find('.chip');
		    $all.removeClass('active');
		    (cat ? $all.filter(`[data-cat="${cat}"]`) : $all.filter('[data-cat=""]')).addClass('active');
		  }

		  // ì´ë²¤íŠ¸
		  $chips.on('click', '.chip', function(e){
		    e.preventDefault();
		    state.categoryId = $(this).attr('data-cat') || '';
		    setActiveChip(state.categoryId);
		    fetchPosts(false);
		  });

		  $q.on('keydown', function(e){
		    if (e.key === 'Enter'){
		      state.q = $(this).val().trim();
		      fetchPosts(false);
		    }
		  });

		  $qTarget.on('change', function(){
		    state.qTarget = $(this).val();
		    state.q = $q.val().trim();     // í˜„ì¬ ì…ë ¥ê°’ê³¼ í•¨ê»˜ ì ìš©
		    fetchPosts(false);
		  });

		  $btnMore.on('click', function(){ fetchPosts(true); });

		  // ì´ˆê¸° ë¡œë“œ
		  setActiveChip(state.categoryId);
		  fetchPosts(false);
		});
		</script>
	</th:block>
</body>

</html>