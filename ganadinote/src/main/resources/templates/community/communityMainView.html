<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/communityLayoutView}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>ì»¤ë®¤ë‹ˆí‹°</title>
  <link th:href="@{/assets/css/bootstrap.css}" href="/assets/css/bootstrap.css" rel="stylesheet"/>

  <th:block layout:fragment="pageStyles">
    <style>
      .mobile-wrap{max-width:460px;margin:auto}
      .sticky-topbar{position:sticky;top:0;border-bottom:1px solid #eee;z-index:1;padding:.5rem;background:#fff}
      .sticky-topbar .d-flex{margin-bottom:.5rem}
      .chip-scroll{overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;padding-bottom:.3rem;margin-bottom:.6rem}
      .chip{display:inline-block;padding:.45rem .9rem;margin-right:.4rem;border:1px solid #ddd;border-radius:999px;font-size:.95rem;background:#f8f9fa}
      .chip.active{background:#e9ecef;font-weight:600}
      .post-card{border-bottom:1px solid #f1f1f1;padding:20px 8px}
      .fab{position:fixed;right:16px;bottom:calc(var(--footer-h) + 16px);z-index:1}
      .card-text{font-size:.7rem;color:#6c757d}
      .small{font-size:.7rem}

      /* ì¸ë„¤ì¼ ë ˆì´ì•„ì›ƒ */
      .post-card .media{display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:start}
      .post-card.no-thumb .media{grid-template-columns:1fr}
      .post-card .thumb{width:110px;height:110px;object-fit:cover;border-radius:8px;border:1px solid #eee}

      .post-excerpt{
        font-size:.9rem;color:#495057;
        display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden
      }
    </style>
  </th:block>
</head>

<body>
<th:block layout:fragment="contents">
  <div class="mobile-wrap">

    <!-- ìƒë‹¨ ê²€ìƒ‰ + ëŒ€ìƒ ì„ íƒ -->
    <div class="sticky-topbar p-2">
      <div class="d-flex gap-2">
        <select class="form-select form-select-sm" style="max-width:140px" name="qTarget">
          <option value="title"  th:selected="${param.qTarget ?: 'title'} == 'title'">ì œëª©</option>
          <option value="author" th:selected="${param.qTarget} == 'author'">ì‘ì„±ì</option>
        </select>
        <input type="search" class="form-control form-control-sm" name="q" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ í›„ Enter" th:value="${param.q}">
      </div>

      <!-- ì¹´í…Œê³ ë¦¬ ì¹© -->
      <div class="chip-scroll mt-2 pb-1" id="catChips">
        <button class="chip" type="button" data-cat="">ì „ì²´</button>
        <button class="chip" type="button" data-cat="1">ë°œìêµ­ ì‚°ì±…ì½”ìŠ¤</button>
        <button class="chip" type="button" data-cat="3">ë©ë© ì‡¼í•‘ë¦¬ë·°</button>
        <button class="chip" type="button" data-cat="4">ë©ë© ìˆ˜ë‹¤ë°©</button>
        <button class="chip" type="button" data-cat="5">ì‚°ì±…í¬ë£¨ ëª¨ì§‘í•´ìš”!</button>
        <button class="chip" type="button" data-cat="2">ê°™ì´ê°€ìš” ìŠ¤íŒŸ</button>
      </div>
    </div>

    <!-- ê²Œì‹œê¸€ ë¦¬ìŠ¤íŠ¸(SSR ì œê±°, í•­ìƒ JSë¡œ ê·¸ë¦¼) -->
    <div id="list" class="py-3">
      <div class="text-center text-muted">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
    <div class="p-3 text-center">
      <button id="btnMore" class="btn btn-outline-secondary btn-sm w-100" style="display:none">ë”ë³´ê¸°</button>
    </div>
  </div>

  <!-- ìƒˆ ê¸€ ì“°ê¸° ë²„íŠ¼ -->
  <div class="fab">
    <a th:href="@{/community/addPost}" class="btn btn-primary rounded-pill px-3 py-2">ê¸€ì“°ê¸°</a>
  </div>
</th:block>

<th:block layout:fragment="pageScripts">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
$(function(){
  const $list    = $('#list');
  const $btnMore = $('#btnMore');
  const $chips   = $('#catChips');
  const $q       = $('[name="q"]');
  const $qTarget = $('[name="qTarget"]');

  const usp = new URLSearchParams(location.search);

  const state = {
    size: 10,
    offset: 0,
    loading: false,
    categoryId: usp.get('categoryId') || '',
    q:        usp.get('q')        || '',
    qTarget:  usp.get('qTarget')  || 'title'
  };

  if (state.q) $q.val(state.q);
  $qTarget.val(state.qTarget);

  function fmt(iso){
    if(!iso) return '';
    const v = typeof iso === 'string' ? iso.replace(' ', 'T') : iso;
    const d = new Date(v);
    if (isNaN(d)) return iso;
    const z = n => String(n).padStart(2,'0');
    return d.getFullYear()+'.'+z(d.getMonth()+1)+'.'+z(d.getDate())+' '+z(d.getHours())+':'+z(d.getMinutes());
  }
  function esc(s){
    return (s ?? '').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // 1) ì—”í‹°í‹° ë³µì›
  function decodeEntities(s){
    if (s == null) return '';
    const t = document.createElement('textarea');
    t.innerHTML = s;
    return t.value;
  }

  // 2) ì ˆëŒ€ê²½ë¡œ ë³´ì •
  function toAbsUrl(url){
    if(!url) return null;
    if (url.startsWith('//')) return location.protocol + url;
    if (/^(data:|https?:\/\/)/i.test(url)) return url;
    try { return new URL(url, location.origin).toString(); } catch { return url; }
  }

  // 3) ë¬¸ìì—´ì—ì„œ ì²« ì´ë¯¸ì§€ URL ì¶”ì¶œ
  function extractFirstImageUrl(html){
    if (!html) return null;
    const decoded = decodeEntities(html);

    const div = document.createElement('div');
    div.innerHTML = decoded;

    let imgEl = div.querySelector('img');
    if (imgEl) {
      const srcFromDom = imgEl.getAttribute('src')
        || imgEl.getAttribute('data-src')
        || (imgEl.getAttribute('srcset') ? imgEl.getAttribute('srcset').split(',')[0].trim().split(' ')[0] : null);
      if (srcFromDom) return toAbsUrl(srcFromDom);
    }

    const anyWithBg = div.querySelector('[style*="background"]');
    if (anyWithBg) {
      const m = anyWithBg.getAttribute('style')?.match(/url\((['"]?)(.*?)\1\)/i);
      if (m && m[2]) return toAbsUrl(m[2]);
    }

    const m1 = decoded.match(/\b(?:src|data-src)\s*=\s*["']([^"']+)["']/i);
    if (m1 && m1[1]) return toAbsUrl(m1[1]);

    const m2 = decoded.match(/\bsrcset\s*=\s*["']([^"']+)["']/i);
    if (m2 && m2[1]) {
      const first = m2[1].split(',')[0].trim().split(' ')[0];
      if (first) return toAbsUrl(first);
    }

    const m3 = decoded.match(/https?:\/\/[^\s"'<>]+\.(?:png|jpe?g|gif|webp)/i);
    if (m3 && m3[0]) return toAbsUrl(m3[0]);

    return null;
  }

  // 4) ë³¸ë¬¸ í…ìŠ¤íŠ¸ ì¶”ì¶œ
  function extractText(html){
    const decoded = decodeEntities(html || '');
    const div = document.createElement('div');
    div.innerHTML = decoded;
    return (div.textContent || '').trim().replace(/\s+/g, ' ');
  }

  function ellipsis(s, n){ if(!s) return ''; return s.length>n ? s.slice(0,n).trim()+'â€¦' : s; }

  // 5) ë Œë”ëŸ¬
  function renderPosts(posts){
    if(!posts || posts.length===0){
      return '<div class="text-center text-muted py-4">ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    return posts.map(p => {
      const thumb = extractFirstImageUrl(p.postCtnt || '');
      const preview = ellipsis(extractText(p.postCtnt || ''), 120);
      const cardCls = thumb ? 'post-card card mb-3' : 'post-card card mb-3 no-thumb';

      return `
        <div class="${cardCls}">
          <div class="card-body">
            <a class="stretched-link" href="/community/postDetail?postId=${esc(p.postId)}"></a>
            <span class="badge bg-secondary mb-2">${esc(p.categoryNm || '')}</span>
            <h6 class="mb-2">${esc(p.postTtl || '')}</h6>

            <div class="media">
              <div>
                <p class="post-excerpt mb-2">${esc(preview)}</p>
                <div class="post-meta small text-muted d-flex gap-2 flex-wrap">
                  <span>${esc(p.mbrNknm || '')}</span>
                  <span>${fmt(p.postRegDate)}</span>
                  <span>ì¡°íšŒ ${p.postViewCount ?? 0}</span>
                </div>
              </div>
              ${thumb ? `<img class="thumb" src="${esc(thumb)}" alt="thumbnail"
                           onerror="this.closest('.post-card').classList.add('no-thumb');this.remove()">` : ``}
            </div>

            <div class="d-flex justify-content-end gap-3 mt-2">
              <span>ğŸ‘ ${p.postLikeCount ?? 0}</span>
              <span>ğŸ’¬ ${p.cmtCount ?? 0}</span>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  function pushUrl(){
    const u = new URL(location.href);
    const p = u.searchParams;
    if (state.categoryId) p.set('categoryId', state.categoryId); else p.delete('categoryId');
    if (state.q)         p.set('q', state.q);                     else p.delete('q');
    if (state.qTarget)   p.set('qTarget', state.qTarget);         else p.delete('qTarget');
    history.replaceState(null, '', u.pathname + '?' + p.toString());
  }

  function fetchPosts(append){
    if (state.loading) return;
    state.loading = true;

    if (!append){
      state.offset = 0;
      $list.html('<div class="text-center text-muted py-4">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>');
    }

    const params = { size: state.size, offset: state.offset };
    if (state.categoryId) params.categoryId = state.categoryId;
    if (state.q)         params.q = state.q.trim();
    if (state.qTarget)   params.qTarget = state.qTarget;

    $.getJSON('/community/api/list', params)
      .done(function(posts){
        if (append) $list.append(renderPosts(posts));
        else $list.html(renderPosts(posts));
        state.offset += (posts?.length || 0);
        $btnMore.toggle((posts?.length || 0) === state.size);
        pushUrl();
      })
      .fail(function(){
        if (!append) $list.html('<div class="text-center text-danger py-4">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>');
        $btnMore.hide();
      })
      .always(function(){ state.loading = false; });
  }

  function setActiveChip(cat){
    const $all = $chips.find('.chip');
    $all.removeClass('active');
    (cat ? $all.filter(`[data-cat="${cat}"]`) : $all.filter('[data-cat=""]')).addClass('active');
  }

  $chips.on('click', '.chip', function(e){
    e.preventDefault();
    state.categoryId = $(this).attr('data-cat') || '';
    setActiveChip(state.categoryId);
    fetchPosts(false);
  });

  $q.on('keydown', function(e){
    if (e.key === 'Enter'){
      state.q = $(this).val().trim();
      fetchPosts(false);
    }
  });

  $qTarget.on('change', function(){
    state.qTarget = $(this).val();
    state.q = $q.val().trim();
    fetchPosts(false);
  });

  $btnMore.on('click', function(){ fetchPosts(true); });

  setActiveChip(state.categoryId);
  fetchPosts(false);
});
</script>
</th:block>
</body>
</html>