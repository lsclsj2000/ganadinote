<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/addPostLayoutView}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>게시글 작성</title>

  <th:block layout:fragment="pageStyles">
    <link rel="stylesheet" href="/assets/vendors/summernote/summernote-lite.min.css" />
    <style>
      .card-header .form-stack .mb-3{display:flex!important;flex-direction:column!important;gap:.35rem;width:100%}
      .card-header .form-stack .form-label{display:block!important;margin-bottom:0;font-size:.95rem;font-weight:600}
      .card-header .form-stack .form-select,.card-header .form-stack .form-control{width:100%;font-size:.95rem;margin:10px 0}
    </style>
  </th:block>
</head>

<body>
<th:block layout:fragment="contents">
  <div class="page-heading">
    <div class="page-title">
      <div class="row">
        <div class="col-12 col-md-6 order-md-1 order-last">
          <h3>게시글 작성</h3>
        </div>
      </div>
    </div>

    <section class="section">
      <div class="row">
        <div class="col-12">
          <!-- ✅ 폼으로 감싸기 -->
          <form id="postWriteForm" th:action="@{/community/post/write}" method="post">
            <!-- Spring Security 쓰면 CSRF 토큰 -->
            <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <div class="card">
              <div class="card-header">
                <div class="form-stack">
                  <!-- 카테고리 -->
                  <div class="mb-3">
                    <label for="filterCategory" class="form-label fw-semibold d-block">카테고리</label>
                    <select id="filterCategory" name="categoryId" class="form-select form-select-sm w-100" required>
                      <option value="" selected>카테고리를 선택해주세요</option>
                      <option value="WALK_COURSE">발자국 산책코스</option>
                      <option value="SHOP_REVIEW">멍멍 쇼핑리뷰</option>
                      <option value="FREE_TALK">멍멍 수다방</option>
                      <option value="CREW_RECRUIT">산책크루 모집해요!</option>
                      <option value="GO_SPOT">같이가요 스팟</option>
                    </select>
                  </div>

                  <!-- 제목 -->
                  <div class="mb-3">
                    <label for="postTitle" class="form-label fw-semibold d-block">제목</label>
                    <input type="text" class="form-control form-control-sm w-100"
                           id="postTitle" name="title" placeholder="제목을 입력하세요" maxlength="200" required>
                  </div>
                </div>
              </div>

              <div class="card-body">
                <!-- ✅ textarea로 변경 (name=content) -->
                <textarea id="editor" name="content"></textarea>
              </div>

              <div class="card-footer d-flex gap-2 justify-content-end">
                <a th:href="@{/community/list}" class="btn btn-outline-secondary">취소</a>
                <button type="button" id="btnSubmit" class="btn btn-primary">등록</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>
  </div>
</th:block>

<th:block layout:fragment="pageScripts">
  <script src="/assets/vendors/jquery/jquery.min.js"></script>
  <script src="/assets/vendors/summernote/summernote-lite.min.js"></script>
  <script>
    $(function () {
      // ✅ Summernote 초기화 + 이미지 콜백
      $('#editor').summernote({
        height: 380,
        lang: 'ko-KR',
        placeholder: '내용을 입력하세요',
        toolbar: [
          ['style', ['bold','italic','underline','clear']],
          ['para', ['ul','ol','paragraph']],
          ['insert', ['picture','link']],
          ['view', ['codeview']]
        ],
        callbacks: {
          onImageUpload: function(files) {
            for (const f of files) uploadImage(f, this);
          }
        }
      });

      // ✅ 서버 업로드 → URL 받아 본문에 삽입
      function uploadImage(file, editor){
        const fd = new FormData();
        fd.append('file', file);
        $.ajax({
          url: '/community/upload-image',
          type: 'POST',
          data: fd,
          processData: false,
          contentType: false,
          success: function(res){
            $(editor).summernote('insertImage', res.url); // {url:"/attachment/..."}
          },
          error: function(xhr){
            alert((xhr.responseJSON && xhr.responseJSON.message) || '이미지 업로드 실패');
          }
        });
      }

      // ✅ 등록 버튼: 간단 검증 후 submit
      $('#btnSubmit').on('click', function(){
        const cat = $('#filterCategory').val();
        const ttl = $('#postTitle').val().trim();
        const html = $('#editor').summernote('code').trim();

        if (!cat){ alert('카테고리를 선택하세요.'); return; }
        if (!ttl){ alert('제목을 입력하세요.'); return; }
        // 내용이 빈값인지 체크 (빈편집기 HTML은 <p><br></p> 등일 수 있음)
        const plain = $('<div>').html(html).text().trim();
        if (!plain && !html.match(/<img\b/i)){ // 이미지도 없고 텍스트도 없으면
          alert('내용을 입력하세요.');
          return;
        }

        $('#postWriteForm').submit();
      });
    });
  </script>
</th:block>
</body>
</html>