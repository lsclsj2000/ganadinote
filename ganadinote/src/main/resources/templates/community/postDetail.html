<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/communityLayoutView}">

<head>
  <meta charset="UTF-8" />
  <title>게시글 상세</title>
  <th:block layout:fragment="pageStyles">
    <style>
		.post-title{word-break:keep-all}
		.post-content{white-space:pre-line;line-height:1.8}
		.author-avatar{width:48px;height:48px;border-radius:50%;object-fit:cover}
		.comment-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover}
		.comment-item{border-bottom:1px solid #f5f5f5}

		/* 폼 토글 */
		.reply-form{display:none}
		.reply-form.show{display:block}

		/* 부모/자식 공통: 기준점만 */
		.comment-item{
		  position: relative;
		}

		/* 대댓글 전용(부모엔 적용 X) */
		.child-reply{
		  position: relative;
		  margin-left: 28px;   /* 들여쓰기 */
		  padding-left: 16px;  /* 본문과 ㄴ자 간격 */
		}

		/* ㄴ자 커넥터: 대댓글에만 출력 */
		.child-reply::before{
		  content: "";
		  position: absolute;
		  left: 6px;           /* ㄴ자의 시작 x 위치 (미세조정 가능) */
		  top: 14px;           /* 첫 줄 높이에 맞춤 */
		  width: 16px;
		  height: 16px;
		  border-left: 2px solid #e5e7eb;
		  border-bottom: 2px solid #e5e7eb;
		  border-bottom-left-radius: 6px;
		}
    </style>
  </th:block>
</head>

<th:block layout:fragment="contents">
  <main class="container py-4">

    <!-- 상단 바 -->
    <div class="d-flex align-items-center justify-content-between pb-2 mb-3 border-bottom">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" th:href="@{/community}">
          ← 목록
        </a>
        <h6 class="mb-0" th:text="${post.categoryNm}">카테고리</h6>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm">공유</button>
      </div>
    </div>

    <div class="row g-4">
      <!-- 메인 -->
      <section class="col-12 col-lg-8">
        <!-- 작성자 영역 -->
        <article class="p-3 bg-white border rounded-3 mb-3">
          <div class="d-flex align-items-start gap-3">
            <img class="author-avatar" src="https://placehold.co/96x96" alt="작성자" />
            <div class="flex-grow-1">
              <strong th:text="${post.mbrNknm}">닉네임</strong>
              <div class="d-flex flex-column small text-muted mt-1">
                <span th:text="${#temporals.format(post.postRegDate, 'yyyy.MM.dd HH:mm')}">2025.08.26 12:34</span>
                <span th:text="'조회 ' + ${post.postViewCount}">조회 0</span>
              </div>
            </div>
          </div>
        </article>

        <!-- 본문 -->
        <article class="bg-white border rounded-3 p-3 p-md-4">
          <h3 class="post-title mb-3" th:text="${post.postTtl}">제목</h3>
          <div class="post-content" th:utext="${post.postCtnt}">
            본문 내용
          </div>

          <!-- 툴바 -->
          <div class="d-flex align-items-center justify-content-between mt-4 pt-3 pb-3 border-top border-bottom">
            <div class="d-flex align-items-center gap-2">
              <button type="button" class="btn btn-outline-primary btn-sm">
                👍 <span class="badge text-bg-light ms-1" th:text="${post.postLikeCount}">0</span>
              </button>
              <!-- 스크랩 등 필요 시 여기에 -->
            </div>
            <a class="btn btn-dark btn-sm" th:href="@{/community}">목록으로</a>
          </div>
        </article>

        <!-- 댓글 작성 -->
        <section class="bg-white border rounded-3 p-3 p-md-4 mt-3">
          <h6 class="mb-3">댓글</h6>
          <form th:action="@{/community/comment/add}" method="post" class="d-flex gap-2">
            <input type="hidden" name="postId" th:value="${post.postId}" />
            <input type="text" name="commentCtnt" class="form-control" placeholder="댓글을 입력하세요" required />
            <button type="submit" class="btn btn-primary">등록</button>
          </form>
        </section>

        <!-- 댓글 리스트 -->
        <section class="bg-white border rounded-3 mt-3">
          <ul class="list-unstyled m-0">
            <li th:if="${#lists.isEmpty(comments)}" class="p-4 text-center text-muted">
              아직 댓글이 없습니다.
            </li>

			<li th:each="c : ${comments}"
			    class="comment-item p-3"
			    th:classappend="${c.commentParentId > 0} ? ' child-reply' : ''">
              <div class="d-flex align-items-start gap-2">
                <img class="comment-avatar" src="https://placehold.co/72x72" alt="아바타" />
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <strong th:text="${c.authorNickname}">작성자</strong>
                      <small class="text-muted ms-2"
                             th:text="${#temporals.format(c.commentRegDate, 'yyyy.MM.dd HH:mm')}">2025.08.26 12:34</small>
                    </div>
                  </div>

                  <p class="mb-2" th:text="${c.commentCtnt}">댓글 내용</p>

                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary"
                            type="button"
                            th:attr="data-target=${'replyForm-' + c.commentId}"
                            onclick="toggleReplyForm(this)">대댓글 달기</button>
                  </div>

                  <!-- 대댓글 폼 -->
                  <form class="reply-form mt-2"
                        th:id="${'replyForm-' + c.commentId}"
                        th:action="@{/community/comment/reply}"
                        method="post">
                    <input type="hidden" name="postId" th:value="${post.postId}" />
                    <input type="hidden" name="commentParentId" th:value="${c.commentId}" />
                    <div class="d-flex gap-2">
                      <input type="text" name="commentCtnt" class="form-control" placeholder="대댓글을 입력하세요" required />
                      <button type="submit" class="btn btn-primary">등록</button>
                    </div>
                  </form>
                </div>
              </div>
            </li>
          </ul>
        </section>
      </section>

      <!-- 사이드(필요 시) -->
      <aside class="col-12 col-lg-4">
        <!-- 빈 영역 or 추천글 등 -->
      </aside>
    </div>
  </main>

  <script>
    function toggleReplyForm(btn){
      var id = btn.getAttribute('data-target');
      var el = document.getElementById(id);
      if(!el) return;
      el.classList.toggle('show');
    }
  </script>
</th:block>
</html>