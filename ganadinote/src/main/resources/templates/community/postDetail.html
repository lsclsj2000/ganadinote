<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/communityLayoutView}">

<head>
  <meta charset="UTF-8" />
  <title>ê²Œì‹œê¸€ ìƒì„¸</title>
  <th:block layout:fragment="pageStyles">
    <style>
      .post-title{word-break:keep-all}
      .post-content{white-space:pre-line;line-height:1.8}
      .author-avatar{width:48px;height:48px;border-radius:50%;object-fit:cover}
      .comment-avatar{width:36px;height:36px;border-radius:50%;object-fit:cover}
      .comment-item{border-bottom:1px solid #f5f5f5}

      /* í¼ í† ê¸€ */
      .reply-form{display:none}
      .reply-form.show{display:block}

      /* ë¶€ëª¨/ìì‹ ê³µí†µ: ê¸°ì¤€ì ë§Œ */
      .comment-item{ position: relative; }

      /* ëŒ€ëŒ“ê¸€ ì „ìš©(ë¶€ëª¨ì—” ì ìš© X) */
      .child-reply{
        position: relative;
        margin-left: 28px;   /* ë“¤ì—¬ì“°ê¸° */
        padding-left: 16px;  /* ë³¸ë¬¸ê³¼ ã„´ì ê°„ê²© */
      }
      /* ã„´ì ì»¤ë„¥í„°: ëŒ€ëŒ“ê¸€ì—ë§Œ ì¶œë ¥ */
      .child-reply::before{
        content: "";
        position: absolute;
        left: 6px; top: 14px;
        width: 16px; height: 16px;
        border-left: 2px solid #e5e7eb;
        border-bottom: 2px solid #e5e7eb;
        border-bottom-left-radius: 6px;
      }
    </style>
  </th:block>
</head>

<th:block layout:fragment="contents">
  <main class="container py-4">

    <!-- ìƒë‹¨ ë°” -->
    <div class="d-flex align-items-center justify-content-between pb-2 mb-3 border-bottom">
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm" th:href="@{/community}">
          â† ëª©ë¡
        </a>
        <h6 class="mb-0" th:text="${post.categoryNm}">ì¹´í…Œê³ ë¦¬</h6>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm">ê³µìœ </button>
      </div>
    </div>

    <div class="row g-4">
      <!-- ë©”ì¸ -->
      <section class="col-12 col-lg-8">
        <!-- ì‘ì„±ì ì˜ì—­ -->
        <article class="p-3 bg-white border rounded-3 mb-3">
          <div class="d-flex align-items-start gap-3">
            <img class="author-avatar" src="https://placehold.co/96x96" alt="ì‘ì„±ì" />
            <div class="flex-grow-1">
              <strong th:text="${post.mbrNknm}">ë‹‰ë„¤ì„</strong>
              <div class="d-flex flex-column small text-muted mt-1">
                <span th:text="${#temporals.format(post.postRegDate, 'yyyy.MM.dd HH:mm')}">2025.08.26 12:34</span>
                <span th:text="'ì¡°íšŒ ' + ${post.postViewCount}">ì¡°íšŒ 0</span>
              </div>
            </div>
          </div>
        </article>

        <!-- ë³¸ë¬¸ -->
        <article class="bg-white border rounded-3 p-3 p-md-4">
          <h3 class="post-title mb-3" th:text="${post.postTtl}">ì œëª©</h3>
          <div class="post-content" th:utext="${post.postCtnt}">
            ë³¸ë¬¸ ë‚´ìš©
          </div>

          <!-- íˆ´ë°” -->
          <div class="d-flex align-items-center justify-content-between mt-4 pt-3 pb-3 border-top border-bottom">
            <div class="d-flex align-items-center gap-2">
              <!-- ì¢‹ì•„ìš”ëŠ” ì¶”í›„ fetchë¡œ êµì²´ -->
              <button type="button" class="btn btn-outline-primary btn-sm">
                ğŸ‘ <span class="badge text-bg-light ms-1" th:text="${post.postLikeCount}">0</span>
              </button>
            </div>
            <a class="btn btn-dark btn-sm" th:href="@{/community}">ëª©ë¡ìœ¼ë¡œ</a>
          </div>
        </article>

        <!-- ëŒ“ê¸€ ì‘ì„± -->
        <section class="bg-white border rounded-3 p-3 p-md-4 mt-3">
          <h6 class="mb-3">ëŒ“ê¸€</h6>
          <form id="commentForm" class="d-flex gap-2">
            <input type="hidden" name="postId" th:value="${post.postId}" />
            <input type="text" name="commentCtnt" class="form-control" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required />
            <button type="submit" class="btn btn-primary">ë“±ë¡</button>
          </form>
        </section>

        <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
        <section class="bg-white border rounded-3 mt-3">
          <ul class="list-unstyled m-0">
            <li th:if="${#lists.isEmpty(comments)}" class="p-4 text-center text-muted">
              ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
            </li>

            <li th:each="c : ${comments}"
                class="comment-item p-3"
                th:classappend="${c.commentParentId > 0} ? ' child-reply' : ''">
              <div class="d-flex align-items-start gap-2">
                <img class="comment-avatar" src="https://placehold.co/72x72" alt="ì•„ë°”íƒ€" />
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center justify-content-between">
                    <div>
                      <strong th:text="${c.authorNickname}">ì‘ì„±ì</strong>
                      <small class="text-muted ms-2"
                             th:text="${#temporals.format(c.commentRegDate, 'yyyy.MM.dd HH:mm')}">2025.08.26 12:34</small>
                    </div>
                  </div>

                  <p class="mb-2" th:text="${c.commentCtnt}">ëŒ“ê¸€ ë‚´ìš©</p>

                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary"
                            type="button"
                            th:attr="data-target=${'replyForm-' + c.commentId}"
                            onclick="toggleReplyForm(this)">ëŒ€ëŒ“ê¸€ ë‹¬ê¸°</button>
                  </div>

                  <!-- ëŒ€ëŒ“ê¸€ í¼ -->
                  <form class="reply-form mt-2 reply-form-item"
                        th:id="${'replyForm-' + c.commentId}">
                    <input type="hidden" name="postId" th:value="${post.postId}" />
                    <input type="hidden" name="commentParentId" th:value="${c.commentId}" />
                    <div class="d-flex gap-2">
                      <input type="text" name="commentCtnt" class="form-control" placeholder="ëŒ€ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required />
                      <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                    </div>
                  </form>
                </div>
              </div>
            </li>
          </ul>
        </section>
      </section>

      <!-- ì‚¬ì´ë“œ(í•„ìš” ì‹œ) -->
      <aside class="col-12 col-lg-4">
        <!-- ë¹ˆ ì˜ì—­ or ì¶”ì²œê¸€ ë“± -->
      </aside>
    </div>
  </main>

  <th:block layout:fragment="pageScripts">
    <script src="/assets/js/loginInfo.js"></script>
    <script>
      const LOGIN_PAGE = '/login'; // í•„ìš”ì— ë§ê²Œ ë³€ê²½

      function toggleReplyForm(btn){
        var id = btn.getAttribute('data-target');
        var el = document.getElementById(id);
        if(!el) return;
        el.classList.toggle('show');
      }

      // ê³µí†µ: x-www-form-urlencoded ìš”ì²­ ìœ í‹¸
      async function postFormUrlencoded(url, data){
        const body = new URLSearchParams();
        Object.entries(data).forEach(([k,v]) => body.append(k, v));
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }
          // Authorization í—¤ë”ëŠ” loginInfo.jsê°€ ìë™ìœ¼ë¡œ ë¶™ì„
          , body
        });
        if (res.status === 401) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          location.href = LOGIN_PAGE;
          return null;
        }
        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          console.error('ìš”ì²­ ì‹¤íŒ¨', t);
          alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          return null;
        }
        return await res.json().catch(()=> ({}));
      }

      // ì›ëŒ“ê¸€ ë“±ë¡
      document.getElementById('commentForm')?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fd = new FormData(e.currentTarget);
        const postId = fd.get('postId');
        const commentCtnt = fd.get('commentCtnt')?.trim();
        if (!commentCtnt) return;

        const res = await postFormUrlencoded('/community/api/comment', { postId, commentCtnt });
        if (res) location.reload();
      });

      // ëŒ€ëŒ“ê¸€ ë“±ë¡ (ë™ì  ë‹¤ìˆ˜ í¼)
      document.querySelectorAll('.reply-form-item').forEach(form => {
        form.addEventListener('submit', async (e)=>{
          e.preventDefault();
          const fd = new FormData(e.currentTarget);
          const postId = fd.get('postId');
          const commentParentId = fd.get('commentParentId');
          const commentCtnt = fd.get('commentCtnt')?.trim();
          if (!commentCtnt) return;

          const res = await postFormUrlencoded('/community/api/comment', { postId, commentParentId, commentCtnt });
          if (res) location.reload();
        });
      });
    </script>
  </th:block>
</th:block>
</html>
