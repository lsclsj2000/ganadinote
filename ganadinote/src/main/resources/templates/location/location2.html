<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/mainLayoutView}">
<head>
    <meta charset="UTF-8">
    <title>내 위치 '동' 이름</title>
    <style>
        /* 로딩바 기본 스타일 */
        #loading-bar-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 5px;
            margin: 10px 0;
            display: none; /* 기본은 숨김 */
        }

        #loading-bar {
            width: 0%;
            height: 20px;
            background-color: #4caf50;
            border-radius: 5px;
            text-align: center;
            color: white;
            line-height: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>내 위치 '동' 이름 확인하기</h1>
    <button onclick="getLocationName()">위치 확인</button>
    <p id="status-message"></p>
    <div id="loading-bar-container">
        <div id="loading-bar">0%</div>
    </div>
    <p id="dong-name"></p>

    <script>
        async function getLocationName() {
            const statusMessage = document.getElementById('status-message');
            const LocationNameElement = document.getElementById('dong-name');
            const loadingContainer = document.getElementById('loading-bar-container');
            const loadingBar = document.getElementById('loading-bar');

            statusMessage.textContent = '위치 정보 가져오는 중...';
            LocationNameElement.textContent = '';
            loadingContainer.style.display = 'block';
            loadingBar.style.width = '0%';
            loadingBar.textContent = '0%';

            function updateLoading(percent) {
                loadingBar.style.width = percent + '%';
                loadingBar.textContent = percent + '%';
            }

            // 브라우저가 Geolocation API를 지원하지 않는 경우 IP 기반 fallback
            if (!navigator.geolocation) {
                await fetchIpLocation();
                return;
            }

            try {
                // GPS 좌표 가져오기 시도
                let position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000 });
                }).catch(async () => {
                    // GPS 불가 시 IP 기반 위치 fallback
                    return await fetchIpLocation(true);
                });

                // position이 좌표를 가지고 있는지 확인
                if (position && position.coords && position.coords.latitude) {
                    updateLoading(50);
                    const { latitude, longitude } = position.coords;
                    await fetchServerLocation(latitude, longitude);
                    updateLoading(100);
                } else if (position && position.locationName) {
                    // IP fallback 결과
                    LocationNameElement.textContent = `현재 위치(대략)는 '${position.locationName}' 입니다.`;
                    statusMessage.textContent = '위치 확인 완료!';
                    updateLoading(100);
                } else {
                    // 아무 정보도 없는 경우
                    LocationNameElement.textContent = '위치 정보를 가져올 수 없습니다.';
                    statusMessage.textContent = '위치 확인 실패';
                    updateLoading(0);
                }

            } catch (error) {
                statusMessage.textContent = `오류 발생: ${error.message}`;
                updateLoading(0);
            }

            // IP 기반 위치 가져오기
            async function fetchIpLocation(fromCatch=false) {
                try {
                    statusMessage.textContent = fromCatch 
                        ? 'GPS를 사용할 수 없습니다. IP 기반 위치 추정 중...' 
                        : 'Geolocation API를 지원하지 않습니다. IP 기반 위치 추정 중...';

                    updateLoading(50);
                    const response = await fetch('/locationapi/ipLocation');
                    const data = await response.json();
                    updateLoading(100);

                    if (data.locationName) {
                        LocationNameElement.textContent = `현재 위치(대략)는 '${data.locationName}' 입니다.`;
                        statusMessage.textContent = '위치 확인 완료!';
                    } else {
                        LocationNameElement.textContent = '위치 정보를 찾을 수 없습니다.';
                        statusMessage.textContent = '위치 확인 실패';
                    }

                    return data; // position 대체용
                } catch (error) {
                    statusMessage.textContent = `오류 발생: ${error.message}`;
                    updateLoading(0);
                    return {};
                }
            }

            // 서버에 GPS 좌표 전송 후 동 이름 받아오기
            async function fetchServerLocation(latitude, longitude) {
                try {
                    updateLoading(75);
                    const response = await fetch('/locationapi/location', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ latitude, longitude })
                    });

                    if (!response.ok) {
                        throw new Error('서버 통신 오류');
                    }

                    const data = await response.json();
                    updateLoading(100);

                    if (data.error) {
                        statusMessage.textContent = '위치 정보를 찾을 수 없습니다.';
                        LocationNameElement.textContent = '';
                    } else {
                        LocationNameElement.textContent = `현재 위치는 '${data.locationName}' 입니다.`;
                        statusMessage.textContent = '위치 확인 완료!';
                    }
                } catch (error) {
                    statusMessage.textContent = `오류 발생: ${error.message}`;
                    updateLoading(0);
                }
            }
        }
    </script>
</body>
</html>