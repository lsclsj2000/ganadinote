<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ganadinote.sns.mapper.SnsMapper">
	<resultMap id="feedPostMap" type="ganadinote.common.domain.SnsPost">
		<result property="spCd"         column="sp_cd"/>
		<result property="spCn"         column="sp_cn"/>
		<result property="spRegYmdt"    column="sp_reg_ymdt"/>
		<result property="repImagePath" column="rep_image_path"/>
	</resultMap>
	
	<resultMap id="followUserMap" type="ganadinote.sns.domain.FollowUser">
		<result property="mbrCd"   column="mbr_cd"/>
		<result property="nickname" column="mbr_nknm"/>
		<result property="handle"   column="handle"/>
	</resultMap>

	<insert id="insertPost"
        	parameterType="ganadinote.common.domain.SnsPost"
        	useGeneratedKeys="true" keyProperty="spCd" keyColumn="sp_cd">
        	/* 게시물 업로드 */
			INSERT INTO sns_post (mbr_cd, sp_cn)
			VALUES (#{mbrCd}, #{spCn})
	</insert>
	
	<select id="countPostsByMember" parameterType="int" resultType="long">
		/* myfeed - 게시물 숫자 */
		SELECT COUNT(*)
		FROM sns_post
		WHERE mbr_cd = #{mbrCd}
	</select>

	<select id="countFollowersOfMember" parameterType="int" resultType="long">
		/* myfeed - 팔로워 숫자 */
		SELECT COUNT(*)
		FROM follow
		WHERE following_mbr_cd = #{mbrCd}
	</select>

	<select id="countFollowingsByMember" parameterType="int" resultType="long">
		/* myfeed - 팔로우 숫자 */
		SELECT COUNT(*)
		FROM follow
		WHERE follow_mbr_cd = #{mbrCd}
	</select>
	
	<select id="selectPostsByMember" parameterType="int" resultMap="feedPostMap">
		/* myfeed - 게시물 대표이미지 */
		SELECT sp_cd, mbr_cd, sp_cn, sp_reg_ymdt
		FROM sns_post
		WHERE mbr_cd = #{mbrCd}
		ORDER BY sp_reg_ymdt DESC
	 </select>
	 
	<select id="selectFollowersOfMember" parameterType="int" resultMap="followUserMap">
		/* myfeed- 팔로워 목록 */
		SELECT
		  m.mbr_cd,
		  m.mbr_nknm,
		  CONCAT('@', SUBSTRING_INDEX(m.mbr_email, '@', 1)) AS handle
		FROM follow f
		JOIN member m ON m.mbr_cd = f.follow_mbr_cd
		WHERE f.following_mbr_cd = #{mbrCd}
		ORDER BY f.follow_ymdt DESC
	</select>
	
	<select id="selectFollowingsByMember" parameterType="int" resultMap="followUserMap">
		/* myfeed- 팔로우 목록 */
		SELECT
		  m.mbr_cd,
		  m.mbr_nknm,
		  CONCAT('@', SUBSTRING_INDEX(m.mbr_email, '@', 1)) AS handle
		FROM follow f
		JOIN member m ON m.mbr_cd = f.following_mbr_cd
		WHERE f.follow_mbr_cd = #{mbrCd}
		ORDER BY f.follow_ymdt DESC
	</select>
	

</mapper>